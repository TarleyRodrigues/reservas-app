{# templates/agente_painel.html #}
{% extends 'base.html' %}

{% block title %}Painel do Agente{% endblock %}

{% block content %}
<div class="page-container"> {# Mantém o container principal #}

    <h2 class="page-section-title">Agendamentos</h2> {# Título mais genérico para o painel #}

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flash-messages">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <div class="agendamentos-table-wrapper"> {# Novo wrapper para a tabela #}
        {% if agendamentos_agente %}
        <table class="data-table"> {# Mantém a classe da sua tabela #}
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Tipo de Serviço</th>
                    <th>Empreendimento</th>
                    <th>Unidade</th>
                    <th>Cliente</th>
                    <th>Contato</th>
                    <th>Observações</th>
                    <th>Status</th>
                    <th>Agente Atribuído</th> {# NOVO: Coluna para exibir agente #}
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for agendamento in agendamentos_agente %}
                <tr>
                    <td>{{ agendamento.data }}</td>
                    <td>{{ agendamento.hora }}</td>
                    <td>{{ agendamento.tipo_nome }}</td>
                    <td>{{ agendamento.empreendimento_nome }}</td>
                    <td>{{ agendamento.unidade_nome }}</td>
                    <td>{{ agendamento.cliente_nome }} ({{ agendamento.cliente_email }})</td>
                    <td>{{ agendamento.contato_agendamento if agendamento.contato_agendamento else 'N/A' }}</td>
                    <td>{{ agendamento.observacoes if agendamento.observacoes else 'N/A' }}</td>
                    <td>
                        <span class="status status-{{ agendamento.status | lower }}">
                            {{ agendamento.status }}
                        </span>
                    </td>
                    <td>
                        {% if agendamento.agente_atribuido_id %}
                        {{ agendamento.agente_atribuido_nome }}
                        {% else %}
                        <span class="text-warning">Não Atribuído</span>
                        {% endif %}
                    </td>
                    <td>
                        {# Botão "Atribuir a mim" para agendamentos NÃO atribuídos #}
                        {% if agendamento.agente_atribuido_id is none %}
                        <form action="{{ url_for('atribuir_agendamento_agente') }}" method="POST"
                            style="display:inline-block; margin-right: 5px;">
                            <input type="hidden" name="agendamento_id" value="{{ agendamento.id }}">
                            <button type="submit" class="btn btn-sm btn-primary">Atribuir a mim</button>
                        </form>
                        {% endif %}

                        {# Ações para agendamentos já atribuídos AO AGENTE LOGADO ou se for ADMIN #}
                        {% if agendamento.agente_atribuido_id == current_user.id or current_user.is_admin_user %}
                        {# Usando um dropdown para mudar status #}
                        <form action="{{ url_for('alterar_status_agendamento') }}" method="POST"
                            style="display:inline-block;">
                            <input type="hidden" name="agendamento_id" value="{{ agendamento.id }}">
                            <select name="novo_status" onchange="this.form.submit()" class="status-select">
                                <option value="">Mudar Status</option>
                                <option value="Pendente" {% if agendamento.status=='Pendente' %}selected{% endif %} {%
                                    if agendamento.status !='Pendente' %}disabled{% endif %}>Pendente</option>
                                <option value="Confirmado" {% if agendamento.status=='Confirmado' %}selected{% endif %}
                                    {% if agendamento.status=='Concluído' or agendamento.status=='Cancelado'
                                    %}disabled{% endif %}>Confirmar</option>
                                <option value="Concluído" {% if agendamento.status=='Concluído' %}selected{% endif %}>
                                    Concluir</option>
                                <option value="Cancelado" {% if agendamento.status=='Cancelado' %}selected{% endif %}>
                                    Cancelar</option>
                            </select>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {# Mensagem de ausência de agendamentos, com o novo estilo #}
        <div class="no-agendamentos-info">
            <p>Nenhum agendamento pendente ou confirmado para você no momento.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Adicionar confirmação para formulários de cancelamento
        document.querySelectorAll('.status-select').forEach(selectElement => {
            selectElement.addEventListener('change', function (e) {
                const selectedStatus = e.target.value;
                if (selectedStatus === 'Cancelado') {
                    if (!confirm('Tem certeza que deseja CANCELAR este agendamento? Esta ação pode ser irreversível.')) {
                        e.preventDefault(); // Impede o envio se o usuário cancelar
                        // Para resetar o select para o valor original, pode ser um pouco complexo
                        // Uma alternativa simples é recarregar a página ou manter o valor original.
                        // Para este caso, vamos apenas impedir o envio e deixar o select como está.
                    }
                }
            });
        });
    });
</script>

{# Seu CSS existente para data-table, status, etc. #}
<style>
    /* ... (MANTENHA TODO O SEU CSS EXISTENTE AQUI, POIS VOCÊ JÁ TINHA ESTE BLOCO STYLE NO ARQUIVO) ... */
    .page-container {
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: var(--text);
        margin-bottom: 30px;
    }

    .page-section-title {
        /* NOVO: Classe para títulos de seção */
        color: #007bff;
        /* Cor do título principal */
        text-align: center;
        margin-bottom: 25px;
        font-size: 2.2rem;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .agendamentos-table-wrapper {
        /* Novo wrapper para aplicar sombra e arredondar */
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-top: 20px;
        /* Espaçamento do título */
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0;
        /* Removido para que o wrapper controle */
        /* box-shadow e background-color movidos para .agendamentos-table-wrapper */
    }

    .data-table th,
    .data-table td {
        border: 1px solid var(--input-border);
        padding: 10px 15px;
        text-align: left;
        color: var(--text);
    }

    .data-table th {
        background-color: var(--button-bg);
        color: var(--button-text);
        font-weight: bold;
    }

    .data-table tr:nth-child(even) {
        background-color: var(--input-bg);
    }

    .data-table tr:hover {
        background-color: rgba(var(--input-border-rgb), 0.5);
        cursor: pointer;
    }

    .status {
        padding: 4px 8px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.85em;
        white-space: nowrap;
    }

    .status-pendente {
        background-color: #ffc107;
        color: #333;
    }

    .status-confirmado {
        background-color: #28a745;
        color: #fff;
    }

    .status-cancelado {
        background-color: #dc3545;
        color: #fff;
    }

    .status-concluído {
        background-color: #6c757d;
        color: #fff;
    }

    .data-table .btn-sm {
        padding: 5px 10px;
        font-size: 0.8em;
        margin-right: 5px;
    }

    .data-table form {
        display: inline-block;
    }

    .status-select {
        /* Estilo para o select de status */
        padding: 5px 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        background-color: white;
        cursor: pointer;
        font-size: 0.9em;
        margin-right: 5px;
    }

    .status-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .no-agendamentos-info {
        background-color: var(--form-bg);
        padding: 30px;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .no-agendamentos-info p {
        color: var(--text);
        font-size: 1.15em;
        font-weight: 500;
        margin-bottom: 0;
    }

    /* Removido o ajuste para h2 aqui, pois .page-section-title já faz isso */
</style>
{% endblock %}