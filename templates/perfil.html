{# templates/perfil.html #}
{% extends 'base.html' %}

{% block title %}Meu Perfil{% endblock %} {# Define o t√≠tulo da p√°gina #}

{% block content %}
<div class="form-wrapper"> {# Usa a mesma classe de container do agendar.html #}
    {# <button class="theme-toggle" aria-label="Alternar modo claro e escuro" id="toggleTheme">üåô</button> #}
    {# O toggle de tema √© espec√≠fico do agendar.html, pode ser adicionado aqui se desejar #}

    <h2>Meu Perfil</h2> {# T√≠tulo principal da p√°gina #}

    {# Bot√£o de navega√ß√£o, semelhante ao "Ver Calend√°rio" do agendar.html #}
    <a href="{{ url_for('index') }}" class="header-btn" style="display: inline-block; margin-bottom: 20px;">
        üè† Voltar ao In√≠cio
    </a>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flash-messages">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <form action="{{ url_for('perfil') }}" method="POST" id="perfilForm">
        <h3>Dados Cadastrais</h3>
        {# Mantendo a estrutura label + input direto, como no agendar.html #}
        <label for="nome">Nome Completo:</label>
        <input type="text" id="nome" name="nome" placeholder="Seu nome completo" value="{{ current_user.nome }}"
            required>

        <label for="email">E-mail:</label>
        <input type="email" id="email" name="email" placeholder="seu@email.com" value="{{ current_user.email }}"
            required>

        <label for="telefone">Contato (Telefone):</label>
        <input type="text" id="telefone" name="telefone" placeholder="Ex: (XX) XXXXX-XXXX"
            value="{{ current_user.telefone if current_user.telefone is not none else '' }}">

        <h3 class="mt-4">Alterar Senha</h3>
        <p class="text-muted small">Preencha apenas se desejar alterar sua senha.</p>
        <label for="senha_atual">Senha Atual:</label>
        {# autocomplete="current-password" ou "off" para tentar controlar o autofill #}
        <input type="password" id="senha_atual" name="senha_atual" placeholder="Sua senha atual"
            autocomplete="current-password">

        <label for="nova_senha">Nova Senha:</label>
        {# autocomplete="new-password" instrui o navegador que √© um campo para nova senha #}
        <input type="password" id="nova_senha" name="nova_senha" placeholder="M√≠nimo 6 caracteres" minlength="6"
            autocomplete="new-password">

        <label for="confirmar_nova_senha">Confirmar Nova Senha:</label>
        {# autocomplete="new-password" para a confirma√ß√£o tamb√©m #}
        <input type="password" id="confirmar_nova_senha" name="confirmar_nova_senha" placeholder="Repita a nova senha"
            autocomplete="new-password">
        <div id="senhaError" class="error-message" style="color: #c62828; display: none; margin-top: 5px;"></div>

        <button type="submit" class="btn-agendar mt-4">Atualizar Perfil</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const perfilForm = document.getElementById('perfilForm');
        const senhaAtualInput = document.getElementById('senha_atual');
        const novaSenhaInput = document.getElementById('nova_senha');
        const confirmarNovaSenhaInput = document.getElementById('confirmar_nova_senha');
        const senhaErrorElement = document.getElementById('senhaError');

        function validatePasswordFields() {
            // IMPORTANT: Use .trim() para garantir que espa√ßos em branco n√£o ativem a valida√ß√£o
            const novaSenha = novaSenhaInput.value.trim();
            const confirmarNovaSenha = confirmarNovaSenhaInput.value.trim();
            const senhaAtual = senhaAtualInput.value.trim();

            senhaErrorElement.style.display = 'none';
            senhaErrorElement.textContent = '';

            // A valida√ß√£o de senha S√ì DEVE SER ATIVADA se o campo 'Nova Senha' foi preenchido.
            // Se 'novaSenha' estiver vazio, o usu√°rio N√ÉO deseja alterar a senha.
            if (novaSenha) {
                // Se a nova senha foi fornecida, ent√£o todas as valida√ß√µes de senha s√£o obrigat√≥rias
                if (novaSenha.length < 6) {
                    senhaErrorElement.textContent = 'A nova senha deve ter pelo menos 6 caracteres.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
                if (novaSenha !== confirmarNovaSenha) {
                    senhaErrorElement.textContent = 'A nova senha e a confirma√ß√£o n√£o coincidem.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
                if (!senhaAtual) {
                    senhaErrorElement.textContent = 'Para alterar a senha, sua senha atual √© obrigat√≥ria.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
            } else {
                // Se 'novaSenha' est√° vazia, o usu√°rio n√£o pretende mudar a senha.
                // Mas, se 'senhaAtual' ou 'confirmarNovaSenha' foram preenchidos (ex: por autofill),
                // devemos limpar e ignorar, para evitar valida√ß√µes erradas no backend.
                if (senhaAtual || confirmarNovaSenha) {
                    senhaAtualInput.value = '';
                    confirmarNovaSenhaInput.value = '';
                    // N√£o √© necess√°rio limpar novaSenhaInput, pois sabemos que j√° est√° vazio.
                }
            }

            // Se chegamos aqui, ou a valida√ß√£o de senha passou, ou ela n√£o foi ativada.
            return true;
        }

        // Adiciona listeners para valida√ß√£o em tempo real (input) e ao perder o foco/autofill (change)
        novaSenhaInput.addEventListener('input', validatePasswordFields);
        confirmarNovaSenhaInput.addEventListener('input', validatePasswordFields);
        senhaAtualInput.addEventListener('input', validatePasswordFields);

        novaSenhaInput.addEventListener('change', validatePasswordFields);
        confirmarNovaSenhaInput.addEventListener('change', validatePasswordFields);
        senhaAtualInput.addEventListener('change', validatePasswordFields);


        perfilForm.addEventListener('submit', function (event) {
            // A valida√ß√£o final antes de enviar o formul√°rio
            if (!validatePasswordFields()) {
                event.preventDefault(); // Impede o envio do formul√°rio se a valida√ß√£o client-side falhar
            }
        });
    });
</script>
{% endblock %}