{# templates/perfil.html #}
{% extends 'base.html' %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<div class="form-wrapper">
    <h2>Meu Perfil</h2>

    <a href="{{ url_for('index') }}" class="header-btn" style="display: inline-block; margin-bottom: 20px;">
        üè† Voltar ao In√≠cio
    </a>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flash-messages">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    {# Formul√°rio de Dados Cadastrais e Senha #}
    <form action="{{ url_for('perfil') }}" method="POST" id="perfilForm">
        <h3>Dados Cadastrais</h3>
        <label for="nome">Nome Completo:</label>
        <input type="text" id="nome" name="nome" placeholder="Seu nome completo" value="{{ current_user.nome }}"
            required>

        <label for="email">E-mail:</label>
        <input type="email" id="email" name="email" placeholder="seu@email.com" value="{{ current_user.email }}"
            required>

        <label for="telefone">Contato (Telefone):</label>
        <input type="text" id="telefone" name="telefone" placeholder="Ex: (XX) XXXXX-XXXX"
            value="{{ current_user.telefone if current_user.telefone is not none else '' }}">

        <h3 class="mt-4">Alterar Senha</h3>
        <p class="text-muted small">Preencha apenas se desejar alterar sua senha.</p>
        <label for="senha_atual">Senha Atual:</label>
        <input type="password" id="senha_atual" name="senha_atual" placeholder="Sua senha atual"
            autocomplete="current-password">

        <label for="nova_senha">Nova Senha:</label>
        <input type="password" id="nova_senha" name="nova_senha" placeholder="M√≠nimo 6 caracteres" minlength="6"
            autocomplete="new-password">

        <label for="confirmar_nova_senha">Confirmar Nova Senha:</label>
        <input type="password" id="confirmar_nova_senha" name="confirmar_nova_senha" placeholder="Repita a nova senha"
            autocomplete="new-password">
        <div id="senhaError" class="error-message" style="color: #c62828; display: none; margin-top: 5px;"></div>

        <button type="submit" class="btn-agendar mt-4">Atualizar Perfil</button>
    </form>

    <hr class="my-5" style="border-color: rgba(255, 255, 255, 0.2);"> {# Linha separadora #}

    {# --- NOVO: Se√ß√£o para Foto de Perfil --- #}
    <h3>Foto de Perfil</h3>
    <div class="profile-photo-section">
        <div class="profile-photo-container">
            {% if current_user.foto_perfil %}
            <img id="currentProfilePhoto" src="{{ url_for('static', filename=current_user.foto_perfil) }}"
                alt="Foto de Perfil" class="profile-photo-preview">
            {% else %}
            <div id="currentProfilePhotoPlaceholder" class="profile-photo-preview profile-photo-placeholder">
                {{ current_user.nome[:2].upper() }}
            </div>
            {% endif %}
        </div>
        <p class="text-muted small mt-2">Formatos aceitos: PNG, JPG, JPEG, GIF. Max: 16MB.</p>

        <form id="fotoForm" action="{{ url_for('upload_foto_perfil') }}" method="POST" enctype="multipart/form-data" class="mt-3">
            <label for="fotoInput" class="custom-file-upload-perfil">
                Escolher Nova Foto
            </label>
            <input type="file" id="fotoInput" name="foto" accept="image/png, image/jpeg, image/gif"
                style="display: none;">
            <button type="submit" form="fotoForm" class="btn-agendar btn-small mt-3">Salvar Foto</button>
        </form>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ... (seu JavaScript existente para valida√ß√£o de senha - permanece o mesmo) ...
        const perfilForm = document.getElementById('perfilForm');
        const senhaAtualInput = document.getElementById('senha_atual');
        const novaSenhaInput = document.getElementById('nova_senha');
        const confirmarNovaSenhaInput = document.getElementById('confirmar_nova_senha');
        const senhaErrorElement = document.getElementById('senhaError');

        function validatePasswordFields() {
            const novaSenha = novaSenhaInput.value.trim();
            const confirmarNovaSenha = confirmarNovaSenhaInput.value.trim();
            const senhaAtual = senhaAtualInput.value.trim();

            senhaErrorElement.style.display = 'none';
            senhaErrorElement.textContent = '';

            if (novaSenha) {
                if (novaSenha.length < 6) {
                    senhaErrorElement.textContent = 'A nova senha deve ter pelo menos 6 caracteres.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
                if (novaSenha !== confirmarNovaSenha) {
                    senhaErrorElement.textContent = 'A nova senha e a confirma√ß√£o n√£o coincidem.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
                if (!senhaAtual) {
                    senhaErrorElement.textContent = 'Para alterar a senha, sua senha atual √© obrigat√≥ria.';
                    senhaErrorElement.style.display = 'block';
                    return false;
                }
            } else {
                if (senhaAtual || confirmarNovaSenha) {
                    senhaAtualInput.value = '';
                    confirmarNovaSenhaInput.value = '';
                }
            }
            return true;
        }

        novaSenhaInput.addEventListener('input', validatePasswordFields);
        confirmarNovaSenhaInput.addEventListener('input', validatePasswordFields);
        senhaAtualInput.addEventListener('input', validatePasswordFields);

        novaSenhaInput.addEventListener('change', validatePasswordFields);
        confirmarNovaSenhaInput.addEventListener('change', validatePasswordFields);
        senhaAtualInput.addEventListener('change', validatePasswordFields);

        perfilForm.addEventListener('submit', function (event) {
            if (!validatePasswordFields()) {
                event.preventDefault();
            }
        });

        // --- NOVO: L√≥gica para pr√©-visualiza√ß√£o da imagem de perfil ---
        const fotoInput = document.getElementById('fotoInput');
        const currentProfilePhoto = document.getElementById('currentProfilePhoto');
        const currentProfilePhotoPlaceholder = document.getElementById('currentProfilePhotoPlaceholder');

        if (fotoInput) {
            fotoInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const fileType = file.type;
                    const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];

                    if (!validImageTypes.includes(fileType)) {
                        alert('Por favor, selecione um arquivo de imagem (PNG, JPG, JPEG, GIF).');
                        this.value = ''; // Limpa o input
                        return;
                    }

                    if (file.size > 16 * 1024 * 1024) { // 16MB
                        alert('O arquivo √© muito grande. Tamanho m√°ximo permitido √© 16MB.');
                        this.value = ''; // Limpa o input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (currentProfilePhoto) {
                            currentProfilePhoto.src = e.target.result;
                            currentProfilePhoto.style.display = 'block';
                        } else {
                            // Se n√£o houver img, cria uma e adiciona ao container
                            const img = document.createElement('img');
                            img.id = "currentProfilePhoto";
                            img.src = e.target.result;
                            img.alt = "Foto de Perfil";
                            img.classList.add("profile-photo-preview");
                            document.querySelector('.profile-photo-container').innerHTML = ''; // Limpa placeholder
                            document.querySelector('.profile-photo-container').appendChild(img);
                            // Atualiza a refer√™ncia para a nova imagem
                            currentProfilePhoto = document.getElementById('currentProfilePhoto');
                            if (currentProfilePhotoPlaceholder) {
                                currentProfilePhotoPlaceholder.style.display = 'none';
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
{% endblock %}