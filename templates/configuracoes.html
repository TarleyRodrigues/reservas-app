{% extends 'base.html' %}

{% block content %}
<div class="config-page-container">
    <!-- Menu Lateral -->
    <div class="config-sidebar">
        <ul class="config-menu">
            <li><a href="#" data-target="tipos">Tipos de Agendamento</a></li>
            <li><a href="#" data-target="empreendimentos">Empreendimentos e Unidades</a></li>
            <!-- Adicionar mais itens de menu aqui no futuro, se necessário -->
        </ul>
    </div>

    <!-- Área de Conteúdo Principal -->
    <div class="config-main-content">
        <h1>Configurações do Sistema</h1>

        <!-- Mensagens Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Seção Tipos de Agendamento (inicialmente visível ou controlada por JS) -->
        <div id="config-tipos" class="config-content-section">
            <h2>Tipos de Agendamento</h2>
            <form method="POST" action="{{ url_for('adicionar_tipo') }}" class="config-form">
                <input type="text" name="novo_tipo" placeholder="Nome do novo tipo" required>
                <button type="submit" class="btn-add">Adicionar Tipo</button>
            </form>
            <table class="config-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tipo in tipos %}
                    <tr>
                        <td>{{ tipo.nome }}</td>
                        <td>
                            <span class="status {% if tipo.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if tipo.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            {# Se implementado, botão de toggle_tipo aqui #}
                            <form method="POST" action="{{ url_for('remover_tipo', tipo_id=tipo.id) }}" style="display:inline;" class="form-remove">
                                <button type="submit" class="btn-remove btn-sm">Remover</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3">Nenhum tipo de agendamento cadastrado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Seção Empreendimentos e Unidades (inicialmente oculta ou controlada por JS) -->
        <div id="config-empreendimentos" class="config-content-section" style="display: none;">
            <h2>Empreendimentos</h2>
            <form method="POST" action="{{ url_for('adicionar_empreendimento') }}" class="config-form">
                <input type="text" name="nome" placeholder="Nome do novo empreendimento" required>
                <button type="submit" class="btn-add">Adicionar Empreendimento</button>
            </form>
            <table class="config-table" id="empreendimentos-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Ações</th>
                        <th>Ver Unidades</th>
                    </tr>
                </thead>
                <tbody>
                    {% for empreendimento in empreendimentos %}
                    <tr data-empreendimento-id="{{ empreendimento.id }}">
                        <td>{{ empreendimento.nome }}</td>
                        <td>
                            <span class="status {% if empreendimento.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if empreendimento.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('toggle_empreendimento') }}" style="display:inline;">
                                <input type="hidden" name="empreendimento_id" value="{{ empreendimento.id }}">
                                <button type="submit" class="btn-toggle btn-sm {% if empreendimento.ativo %}btn-warning{% else %}btn-success{% endif %}">
                                    {{ 'Desativar' if empreendimento.ativo else 'Ativar' }}
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('remover_empreendimento', emp_id=empreendimento.id) }}" style="display:inline;" class="form-remove">
                                <button type="submit" class="btn-remove btn-sm">Remover</button>
                            </form>
                        </td>
                        <td>
                            <button class="btn-view-units btn-sm btn-info" data-id="{{ empreendimento.id }}">Ver Unidades</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4">Nenhum empreendimento cadastrado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <hr>
            <!-- Seção de Unidades (será populada por JavaScript) -->
            <div id="unidades-section" style="display: none;">
                <h3 id="unidades-title">Unidades do Empreendimento: <span id="selected-empreendimento-nome"></span></h3>
                <form method="POST" action="{{ url_for('adicionar_unidade') }}" class="config-form" id="form-adicionar-unidade">
                    <input type="hidden" name="empreendimento_id" id="form-unidade-empreendimento-id" value="">
                    <input type="text" name="nome" placeholder="Nome da nova unidade" required>
                    <button type="submit" class="btn-add">Adicionar Unidade</button>
                </form>
                <table class="config-table" id="unidades-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Linhas de unidades serão inseridas aqui por JS -->
                        <tr><td colspan="3" id="no-units-message">Selecione um empreendimento para ver suas unidades.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const menuLinks = document.querySelectorAll('.config-menu a');
    const contentSections = document.querySelectorAll('.config-content-section');
    const unidadesSection = document.getElementById('unidades-section');
    const unidadesTableBody = document.querySelector('#unidades-table tbody');
    const selectedEmpreendimentoNome = document.getElementById('selected-empreendimento-nome');
    const formUnidadeEmpreendimentoId = document.getElementById('form-unidade-empreendimento-id');
    const noUnitsMessageRow = document.getElementById('no-units-message').parentNode; // A linha <tr> que contém a mensagem

    // Função para mostrar a seção correta e atualizar o menu
    function showSection(targetId) {
        contentSections.forEach(section => {
            section.style.display = (section.id === 'config-' + targetId) ? 'block' : 'none';
        });
        menuLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.target === targetId);
        });
        // Se não for a seção de empreendimentos, esconde a seção de unidades
        if (targetId !== 'empreendimentos') {
            unidadesSection.style.display = 'none';
        } else {
            // Se for a seção de empreendimentos, mas nenhuma unidade carregada, mostra a mensagem inicial
            if (unidadesTableBody.children.length <= 1 && unidadesTableBody.contains(noUnitsMessageRow)) { // <=1 para contar o <tr> da mensagem
                 unidadesSection.style.display = 'block'; // Mostra a seção de unidades
            }
        }
    }

    // Event listener para os links do menu
    menuLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const target = this.dataset.target;
            showSection(target);
            // Se clicou em empreendimentos, reseta a seleção de unidades
            if (target === 'empreendimentos') {
                resetUnidadesView();
            }
        });
    });

    // Mostrar a primeira seção por padrão (ou a que tiver 'active' no HTML)
    showSection('tipos'); // Ou 'empreendimentos' se preferir

    // Event listeners para botões "Ver Unidades"
    document.querySelectorAll('.btn-view-units').forEach(button => {
        button.addEventListener('click', function() {
            const empreendimentoId = this.dataset.id;
            const empreendimentoNome = this.closest('tr').querySelector('td:first-child').textContent;
            loadUnidades(empreendimentoId, empreendimentoNome);
        });
    });

    function resetUnidadesView() {
        unidadesTableBody.innerHTML = ''; // Limpa a tabela
        unidadesTableBody.appendChild(noUnitsMessageRow); // Adiciona a mensagem de volta
        noUnitsMessageRow.style.display = ''; // Garante que a mensagem é visível
        selectedEmpreendimentoNome.textContent = '';
        formUnidadeEmpreendimentoId.value = '';
        unidadesSection.style.display = 'block'; // Mantém a seção de unidades visível mas vazia
    }

    async function loadUnidades(empreendimentoId, empreendimentoNome) {
        selectedEmpreendimentoNome.textContent = empreendimentoNome;
        formUnidadeEmpreendimentoId.value = empreendimentoId; // Preenche o ID no form de adicionar unidade
        unidadesSection.style.display = 'block';
        unidadesTableBody.innerHTML = '<tr><td colspan="3">Carregando unidades...</td></tr>'; // Feedback de carregamento

        try {
            const response = await fetch(`/api/empreendimento/${empreendimentoId}/unidades`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const unidades = await response.json();
            
            unidadesTableBody.innerHTML = ''; // Limpa o "Carregando..."
            if (unidades.length === 0) {
                unidadesTableBody.appendChild(noUnitsMessageRow);
                noUnitsMessageRow.querySelector('td').textContent = 'Nenhuma unidade cadastrada para este empreendimento.';
                noUnitsMessageRow.style.display = '';
            } else {
                noUnitsMessageRow.style.display = 'none'; // Esconde a mensagem se há unidades
                unidades.forEach(unidade => {
                    const row = unidadesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${unidade.nome}</td>
                        <td>
                            <span class="status ${unidade.ativo ? 'status-active' : 'status-inactive'}">
                                ${unidade.ativo ? 'Ativa' : 'Inativa'}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="/toggle_unidade/${unidade.id}" style="display:inline;">
                                <input type="hidden" name="unidade_id" value="${unidade.id}">
                                <button type="submit" class="btn-toggle btn-sm ${unidade.ativo ? 'btn-warning' : 'btn-success'}">
                                    ${unidade.ativo ? 'Desativar' : 'Ativar'}
                                </button>
                            </form>
                            <form method="POST" action="/remover_unidade/${unidade.id}" style="display:inline;" class="form-remove">
                                <button type="submit" class="btn-remove btn-sm">Remover</button>
                            </form>
                        </td>
                    `;
                    // Adicionar event listener para o novo botão de remover (se necessário, pois a página não recarrega)
                    const removeForm = row.querySelector('.form-remove');
                    if(removeForm) { // Adicionar confirmação para botões carregados dinamicamente
                        addConfirmationToForm(removeForm);
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao carregar unidades:', error);
            unidadesTableBody.innerHTML = '<tr><td colspan="3" class="text-danger">Erro ao carregar unidades. Tente novamente.</td></tr>';
        }
    }
    
    // Confirmação de remoção (reutilizada e aplicada dinamicamente)
    function addConfirmationToForm(form) {
        form.addEventListener('submit', function (e) {
            if (!confirm('Tem certeza que deseja remover este item? Esta ação não pode ser desfeita.')) {
                e.preventDefault();
            }
        });
    }
    // Aplicar aos formulários de remoção já existentes na página
    document.querySelectorAll('form.form-remove').forEach(form => {
        addConfirmationToForm(form);
    });

});
</script>
{% endblock %}