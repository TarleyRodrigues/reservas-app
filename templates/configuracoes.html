{# templates/configuracoes.html #}

{% extends 'base.html' %}

{% block head %}
{{ super() }}
{# Não é necessário nenhuma tag <style> inline aqui se todo o CSS está em arquivos externos #}
{% endblock %}

{% block content %}
<div class="config-page-container">
    <div class="config-sidebar">
        <ul class="config-menu">
            <li><a href="#tipos" data-target="tipos" class="config-menu-link">Tipos de Agendamento</a></li>
            <li><a href="#empreendimentos" data-target="empreendimentos" class="config-menu-link">Empreendimentos e Unidades</a></li>
            <li><a href="#usuarios" data-target="usuarios" class="config-menu-link">Gerenciamento de Usuários</a></li>
            <li><a href="#horarios" data-target="horarios" class="config-menu-link">Horários de Funcionamento</a></li>
            <li><a href="#seguranca" data-target="seguranca" class="config-menu-link">Segurança (Administradores)</a></li>
            {# NOVO: Aba Regras de Reservas #}
            <li><a href="#regras" data-target="regras" class="config-menu-link">Regras de Reservas</a></li>
        </ul>
    </div>

    <div class="config-main-content">
        <h1>Configurações do Sistema</h1>

        {# Mensagens Flash (já são tratadas pelo showToast em base.html, este bloco é um fallback visual) #}
        {% with messages=get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <ul class="flash-messages">
            {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}

        {# Conteúdo da aba "Tipos de Agendamento" #}
        <div id="config-tipos" class="config-content-section">
            <h2>Tipos de Agendamento</h2>
            <form method="POST" action="{{ url_for('adicionar_tipo') }}" class="config-form">
                <label for="novo_tipo_nome">Nome do novo tipo:</label>
                <input type="text" id="novo_tipo_nome" name="novo_tipo" placeholder="Ex: Visita ao Imóvel" required>
                <label for="tipo_duracao">Duração padrão (minutos):</label>
                <input type="number" id="tipo_duracao" name="duracao" placeholder="60" value="60" min="1" required>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Tipo</button>
            </form>
            <table class="config-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Duração Padrão (min)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tipo in tipos %}
                    <tr>
                        <td>{{ tipo.nome }}</td>
                        <td>
                            <span class="status {% if tipo.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if tipo.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('editar_duracao_tipo') }}" style="display:inline;"
                                class="form-edit-duracao">
                                <input type="hidden" name="tipo_id" value="{{ tipo.id }}">
                                <input type="number" name="duracao" value="{{ tipo.duracao_minutos }}" min="1" required
                                    class="small-input">
                                <button type="submit" class="btn btn-success btn-sm">Salvar</button>
                            </form>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('remover_tipo', tipo_id=tipo.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Nenhum tipo de agendamento cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Conteúdo da aba "Empreendimentos & Unidades" #}
        <div id="config-empreendimentos" class="config-content-section" style="display: none;">
            <h2>Empreendimentos</h2>
            <form method="POST" action="{{ url_for('adicionar_empreendimento') }}" class="config-form">
                <label for="novo_empreendimento_nome">Nome do empreendimento:</label>
                <input type="text" id="novo_empreendimento_nome" name="nome" placeholder="Ex: Condomínio Alfa" required>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Empreendimento</button>
            </form>
            <table class="config-table" id="empreendimentos-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Ações</th>
                        <th>Unidades</th>
                    </tr>
                </thead>
                <tbody>
                    {% for empreendimento in empreendimentos %}
                    <tr data-empreendimento-id="{{ empreendimento.id }}">
                        <td>{{ empreendimento.nome }}</td>
                        <td>
                            <span
                                class="status {% if empreendimento.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if empreendimento.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('toggle_empreendimento') }}" style="display:inline;">
                                <input type="hidden" name="empreendimento_id" value="{{ empreendimento.id }}">
                                <button type="submit"
                                    class="btn btn-sm {% if empreendimento.ativo %}btn-toggle btn-warning{% else %}btn-toggle btn-success{% endif %}">
                                    {{ 'Desativar' if empreendimento.ativo else 'Ativar' }}
                                </button>
                            </form>
                            <form method="POST"
                                action="{{ url_for('remover_empreendimento', emp_id=empreendimento.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                            </form>
                        </td>
                        <td>
                            <button class="btn-view-units btn btn-info btn-sm" data-id="{{ empreendimento.id }}">Ver
                                Unidades</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Nenhum empreendimento cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr>
            <div id="unidades-section" style="display: none;">
                <h3 id="unidades-title">Unidades do Empreendimento: <span id="selected-empreendimento-nome"></span></h3>
                <form method="POST" action="{{ url_for('adicionar_unidade') }}" class="config-form"
                    id="form-adicionar-unidade">
                    <input type="hidden" name="empreendimento_id" id="form-unidade-empreendimento-id" value="">
                    <label for="unidade_nome">Nome da nova unidade:</label>
                    <input type="text" id="unidade_nome" name="nome" placeholder="Ex: Apartamento 101" required>
                    <button type="submit" class="btn btn-primary btn-sm">Adicionar Unidade</button>
                </form>
                <table class="config-table" id="unidades-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" id="no-units-message">Selecione um empreendimento para ver suas unidades.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# SEÇÃO DE GERENCIAMENTO DE USUÁRIOS #}
        <div id="config-usuarios" class="config-content-section" style="display: none;">
            <h2>Gerenciamento de Usuários</h2>

            {# NOVO FORMULÁRIO: Adicionar novo Agente #}
            <h3>Cadastrar Novo Agente</h3>
            <form method="POST" action="{{ url_for('adicionar_agente') }}" class="config-form config-form-vertical">
                <label for="agente_nome">Nome:</label>
                <input type="text" id="agente_nome" name="nome" placeholder="Nome completo do agente" required>

                <label for="agente_email">Email:</label>
                <input type="email" id="agente_email" name="email" placeholder="email@exemplo.com" required>

                <label for="agente_telefone">Telefone (opcional):</label>
                <input type="tel" id="agente_telefone" name="telefone" placeholder="(XX) XXXXX-XXXX">

                <label for="agente_senha">Senha:</label>
                <input type="password" id="agente_senha" name="senha" placeholder="Mínimo 6 caracteres" required>

                <label for="agente_confirmar_senha">Confirmar Senha:</label>
                <input type="password" id="agente_confirmar_senha" name="confirmar_senha" placeholder="Repita a senha"
                    required>

                <button type="submit" class="btn btn-primary btn-sm">Cadastrar Agente</button>
            </form>

            <hr>

            <h3>Agentes Atuais</h3>
            {% if agente_users %}
            <table class="config-table" id="agente-users-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Tipos de Serviço Vinculados</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in agente_users %}
                    <tr data-user-id="{{ user.id }}" data-user-name="{{ user.nome }}">
                        <td>{{ user.nome if user.nome else 'N/A' }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.telefone if user.telefone else 'Não informado' }}</td>
                        <td>
                            <span id="agente-servicos-{{ user.id }}">
                                Carregando...
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('gerenciar_agente') }}" style="display:inline;"
                                class="form-action-user">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <input type="hidden" name="action" value="demover">
                                <button type="submit" class="btn btn-warning btn-sm">Remover Status Agente</button>
                            </form>
                            <button class="btn btn-info btn-sm btn-gerenciar-servicos" data-user-id="{{ user.id }}"
                                data-user-name="{{ user.nome }}">Gerenciar Serviços</button>
                        </td>
                    </tr>
                    <tr class="agente-servicos-details" id="agente-servicos-row-{{ user.id }}" style="display: none;">
                        <td colspan="5">
                            <div class="servicos-form-container">
                                <h4>Vincular Tipos de Serviço para {{ user.nome if user.nome else user.email }}</h4>
                                <form method="POST" action="{{ url_for('vincular_servicos_agente') }}"
                                    class="form-vincular-servicos">
                                    <input type="hidden" name="agente_id" value="{{ user.id }}">
                                    <div class="checkbox-group">
                                        {% for tipo in tipos %}
                                        <div class="checkbox-item">
                                            <label for="tipo_servico_{{ user.id }}_{{ tipo.id }}">
                                                <input type="checkbox" id="tipo_servico_{{ user.id }}_{{ tipo.id }}"
                                                    name="tipos_servico[]" value="{{ tipo.id }}">
                                                {{ tipo.nome }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">Salvar Vinculação</button>
                                    <button type="button"
                                        class="btn btn-secondary btn-sm btn-cancelar-servicos">Cancelar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum Agente cadastrado no momento.</p>
            {% endif %}

            <hr>

            <h3>Promover Usuário a Agente</h3>
            {% if non_admin_users %}
            <form method="POST" action="{{ url_for('gerenciar_agente') }}" id="form-promover-agente" class="config-form config-form-vertical">
                <label for="promover_agente_user_id">Selecione um usuário:</label>
                <input type="hidden" name="action" value="promover">
                <select id="promover_agente_user_id" name="user_id" required>
                    <option value="">Selecione um usuário...</option>
                    {% for user in non_admin_users %}
                    <option value="{{ user.id }}">{{ user.nome if user.nome else user.email }} ({{ user.email }}) [{{
                        user.tipo_usuario.capitalize() }}]</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success btn-sm">Tornar Agente</button>
            </form>
            {% else %}
            <p>Não há usuários (clientes ou agentes) para promover a administrador no momento.</p>
            {% endif %}
        </div>

        {# SEÇÃO PARA HORÁRIOS DE FUNCIONAMENTO #}
        <div id="config-horarios" class="config-content-section" style="display: none;">
            <h2>Gerenciar Horários de Funcionamento dos Empreendimentos</h2>

            <h3>Adicionar Horário de Funcionamento</h3>
            <form method="POST" action="{{ url_for('adicionar_horario_funcionamento') }}" class="config-form config-form-vertical">
                <label for="horario_empreendimento_id_form">Empreendimento:</label>
                <select id="horario_empreendimento_id_form" name="empreendimento_id" required>
                    <option value="" disabled selected>Selecione um empreendimento</option>
                    {% for emp in empreendimentos %}
                    <option value="{{ emp.id }}">{{ emp.nome }}</option>
                    {% endfor %}
                </select>

                <label for="dia_semana_form">Dia da Semana:</label>
                <select id="dia_semana_form" name="dia_semana" required>
                    <option value="" disabled selected>Selecione o dia</option>
                    <option value="0">Segunda-feira</option>
                    <option value="1">Terça-feira</option>
                    <option value="2">Quarta-feira</option>
                    <option value="3">Quinta-feira</option>
                    <option value="4">Sexta-feira</option>
                    <option value="5">Sábado</option>
                    <option value="6">Domingo</option>
                </select>

                <label for="hora_inicio_form">Hora Início:</label>
                <input type="time" id="hora_inicio_form" name="hora_inicio" required>

                <label for="hora_fim_form">Hora Fim:</label>
                <input type="time" id="hora_fim_form" name="hora_fim" required>

                <button type="submit" class="btn btn-primary btn-sm">Adicionar Horário</button>
            </form>

            <hr>

            <h3>Horários Cadastrados</h3>
            <table class="config-table" id="horarios-table">
                <thead>
                    <tr>
                        <th>Empreendimento</th>
                        <th>Dia da Semana</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">Nenhum horário cadastrado. Selecione um empreendimento acima para ver seus
                            horários ou adicione um novo.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="config-seguranca" class="config-content-section" style="display: none;">
            <h2>Gerenciamento de Administradores</h2>
            <h3>Administradores Atuais</h3>
            {% if admin_users %}
            <table class="config-table" id="admin-users-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for admin_user in admin_users %}
                    <tr>
                        <td>{{ admin_user.nome if admin_user.nome else 'N/A' }}</td>
                        <td>{{ admin_user.email }}</td>
                        <td>{{ admin_user.telefone if admin_user.telefone else 'Não informado' }}</td>
                        <td>
                            {# Não permita que um admin remova a si mesmo ou o super admin #}
                            {% if admin_user.id != current_user.id and admin_user.email != super_admin_email %}
                            <form method="POST" action="{{ url_for('remover_admin', user_id=admin_user.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover Status Admin</button>
                            </form>
                            {% elif admin_user.id == current_user.id %}
                            <span>(Você)</span>
                            {% elif admin_user.email == super_admin_email %}
                            <span>(Admin Principal)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum administrador configurado (além do principal, se houver).</p>
            {% endif %}
            <hr>
            <h3>Promover Usuário a Administrador</h3>
            {# non_admin_users é agora passado diretamente da rota Flask #}
            {% if non_admin_users %}
            <form method="POST" action="{{ url_for('promover_admin') }}" id="form-promover-admin" class="config-form config-form-vertical">
                <label for="promover_admin_user_id">Selecione um usuário:</label>
                <select id="promover_admin_user_id" name="user_to_promote_id" required>
                    <option value="">Selecione um usuário...</option>
                    {% for user in non_admin_users %}
                    <option value="{{ user.id }}">{{ user.nome if user.nome else user.email }} ({{ user.email }}) [{{
                        user.tipo_usuario.capitalize() }}]</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success btn-sm">Tornar Admin</button>
            </form>
            {% else %}
            <p>Não há usuários (clientes ou agentes) para promover a administrador no momento.</p>
            {% endif %}
        </div>

        {# --- NOVO: SEÇÃO DE REGRAS DE RESERVAS --- #}
        <div id="config-regras" class="config-content-section" style="display: none;">
            <h2>Regras de Reservas</h2>
            <h3>Antecedência Mínima de Agendamento</h3>
            <p>Defina quantas horas de antecedência são necessárias para que um agendamento possa ser feito (ex: 2 horas significa que agendamentos de última hora não são permitidos).</p>
            <form method="POST" action="{{ url_for('salvar_regras_reservas') }}" class="config-form config-form-vertical">
                <label for="min_antecedencia_horas">Mínimo de Horas de Antecedência:</label>
                <input type="number" id="min_antecedencia_horas" name="min_antecedencia_horas" 
                       placeholder="0" value="{{ min_antecedencia_horas }}" min="0" required> {# CORRIGIDO AQUI: value="{{ min_antecedencia_horas }}" #}
                <button type="submit" class="btn btn-primary btn-sm">Salvar Regra</button>
            </form>
            <hr>
            <h3>Antecedência Máxima de Agendamento</h3>
            <p>Defina quantos meses de antecedência são permitidos para novos agendamentos (ex: 6 meses significa que não é possível agendar para daqui mais de 6 meses).</p>
            <form method="POST" action="{{ url_for('salvar_regras_reservas') }}" class="config-form config-form-vertical">
                <label for="max_antecedencia_meses">Máximo de Meses de Antecedência:</label>
                <input type="number" id="max_antecedencia_meses" name="max_antecedencia_meses" 
                       placeholder="12" value="{{ max_antecedencia_meses }}" min="0" required> {# CORRIGIDO AQUI: value="{{ max_antecedencia_meses }}" #}
                <button type="submit" class="btn btn-primary btn-sm">Salvar Regra</button>
            </form>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const menuLinks = document.querySelectorAll('.config-menu-link');
        const contentSections = document.querySelectorAll('.config-content-section');
        const unidadesSection = document.getElementById('unidades-section');
        const unidadesTableBody = document.querySelector('#unidades-table tbody');
        const selectedEmpreendimentoNome = document.getElementById('selected-empreendimento-nome');
        const formUnidadeEmpreendimentoId = document.getElementById('form-unidade-empreendimento-id');
        const noUnitsMessageRowOriginal = document.getElementById('no-units-message').parentNode.cloneNode(true);

        const horarioEmpreendimentoSelect = document.getElementById('horario_empreendimento_id_form');
        const horariosTableBody = document.querySelector('#horarios-table tbody');

        const diasSemanaMap = {
            '0': 'Segunda-feira',
            '1': 'Terça-feira',
            '2': 'Quarta-feira',
            '3': 'Quinta-feira',
            '4': 'Sexta-feira',
            '5': 'Sábado',
            '6': 'Domingo'
        };

        function showSection(targetId, keepUnitsVisible = false) {
            contentSections.forEach(section => {
                section.style.display = (section.id === 'config-' + targetId) ? 'block' : 'none';
            });
            menuLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.target === targetId);
            });

            if (targetId !== 'empreendimentos' && !keepUnitsVisible) {
                unidadesSection.style.display = 'none';
            } else if (targetId === 'empreendimentos') {
                const urlParams = new URLSearchParams(window.location.search);
                const activeEmpIdFromUrl = urlParams.get('active_emp_id');
                if (activeEmpIdFromUrl) {
                    const empRow = document.querySelector(`#empreendimentos-table tr[data-empreendimento-id="${activeEmpIdFromUrl}"]`);
                    if (empRow) {
                        const empName = empRow.querySelector('td:first-child').textContent;
                        loadUnidades(activeEmpIdFromUrl, empName);
                    } else {
                        resetUnidadesView();
                        unidadesSection.style.display = 'block';
                    }
                } else if (unidadesTableBody.children.length > 0 && unidadesTableBody.firstChild.id !== 'no-units-message') {
                    unidadesSection.style.display = 'block';
                } else {
                    resetUnidadesView();
                    unidadesSection.style.display = 'block';
                }
            }
            if (targetId === 'usuarios') {
                loadAgenteServicos();
            }
            if (targetId === 'horarios') {
                const selectedEmpId = horarioEmpreendimentoSelect.value;
                if (selectedEmpId) {
                    loadHorariosEmpreendimento(selectedEmpId);
                } else {
                    horariosTableBody.innerHTML = '<tr><td colspan="5">Nenhum horário cadastrado. Selecione um empreendimento acima para ver seus horários ou adicione um novo.</td></tr>';
                }
            }
            // Não há lógica JS complexa para a aba 'regras' ao ser ativada
        }

        menuLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const target = this.dataset.target;
                history.pushState(null, '', `{{ url_for('configuracoes') }}?tab=${target}`);
                showSection(target);
            });
        });

        document.querySelectorAll('.btn-view-units').forEach(button => {
            button.addEventListener('click', function () {
                const empreendimentoId = this.dataset.id;
                const empreendimentoNome = this.closest('tr').querySelector('td:first-child').textContent;
                history.pushState(null, '', `{{ url_for('configuracoes') }}?tab=empreendimentos&active_emp_id=${empreendimentoId}`);
                loadUnidades(empreendimentoId, empreendimentoNome);
            });
        });

        function resetUnidadesView() {
            unidadesTableBody.innerHTML = '';
            unidadesTableBody.appendChild(noUnitsMessageRowOriginal.cloneNode(true));
            selectedEmpreendimentoNome.textContent = '';
            formUnidadeEmpreendimentoId.value = '';
        }

        async function loadUnidades(empreendimentoId, empreendimentoNome) {
            selectedEmpreendimentoNome.textContent = empreendimentoNome;
            formUnidadeEmpreendimentoId.value = empreendimentoId;
            unidadesSection.style.display = 'block';
            unidadesTableBody.innerHTML = '<tr><td colspan="3">Carregando unidades...</td></tr>';

            try {
                const response = await fetch(`/api/empreendimento/${empreendimentoId}/unidades`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: "Erro desconhecido ao buscar unidades." }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                const unidades = await response.json();

                unidadesTableBody.innerHTML = '';
                if (unidades.length === 0) {
                    const noUnitsMsg = noUnitsMessageRowOriginal.cloneNode(true);
                    noUnitsMsg.querySelector('td').textContent = 'Nenhuma unidade cadastrada para este empreendimento.';
                    unidadesTableBody.appendChild(noUnitsMsg);
                } else {
                    unidades.forEach(unidade => {
                        const row = unidadesTableBody.insertRow();
                        const toggleUrl = `/toggle_unidade/${unidade.id}`;
                        const removeUrl = `/remover_unidade/${unidade.id}`;

                        row.innerHTML = `
                            <td>${unidade.nome}</td>
                            <td>
                                <span class="status ${unidade.ativo ? 'status-active' : 'status-inactive'}">
                                    ${unidade.ativo ? 'Ativa' : 'Inativa'}
                                </span>
                            </td>
                            <td>
                                <form method="POST" action="${toggleUrl}" style="display:inline;">
                                    <input type="hidden" name="unidade_id" value="${unidade.id}">
                                    <input type="hidden" name="source_empreendimento_id" value="${empreendimentoId}">
                                    <button type="submit" class="btn btn-sm ${unidade.ativo ? 'btn-toggle btn-warning' : 'btn-toggle btn-success'}">
                                        ${unidade.ativo ? 'Desativar' : 'Ativar'}
                                    </button>
                                </form>
                                <form method="POST" action="${removeUrl}" style="display:inline;" class="form-remove">
                                    <input type="hidden" name="source_empreendimento_id" value="${empreendimentoId}">
                                    <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                                </form>
                            </td>
                        `;
                        const removeForm = row.querySelector('.form-remove');
                        if (removeForm) { addConfirmationToForm(removeForm); }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar unidades:', error);
                unidadesTableBody.innerHTML = `<tr><td colspan="3" class="text-danger">Erro ao carregar unidades: ${error.message}</td></tr>`;
            }
        }

        function addConfirmationToForm(form) {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este item? Esta ação não pode ser desfeita.')) {
                    e.preventDefault();
                }
            });
        }
        document.querySelectorAll('form.form-remove').forEach(form => {
            addConfirmationToForm(form);
        });

        document.querySelectorAll('form.form-action-user').forEach(form => {
            form.addEventListener('submit', function (e) {
                const actionType = this.querySelector('input[name="action"]').value;
                let message = '';
                if (actionType === 'promover') {
                    message = 'Tem certeza que deseja promover este usuário a Agente?';
                } else if (actionType === 'demover') {
                    message = 'Tem certeza que deseja remover o status de Agente deste usuário? Ele se tornará um Cliente.';
                } else {
                    message = 'Tem certeza que deseja realizar esta ação?';
                }
                if (!confirm(message)) {
                    e.preventDefault();
                }
            });
        });

        const agenteServicosDetails = document.querySelectorAll('.agente-servicos-details');

        document.querySelectorAll('.btn-gerenciar-servicos').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.dataset.userId;
                const userName = this.dataset.userName;
                const detailRow = document.getElementById(`agente-servicos-row-${userId}`);

                agenteServicosDetails.forEach(row => {
                    if (row.id !== `agente-servicos-row-${userId}`) {
                        row.style.display = 'none';
                    }
                });

                if (detailRow.style.display === 'none') {
                    detailRow.style.display = 'table-row';
                    loadAgenteTiposServico(userId, detailRow.querySelector('.form-vincular-servicos'));
                } else {
                    detailRow.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.btn-cancelar-servicos').forEach(button => {
            button.addEventListener('click', function () {
                this.closest('.agente-servicos-details').style.display = 'none';
            });
        });

        async function loadAgenteServicos() {
            const agenteRows = document.querySelectorAll('#agente-users-table tbody tr[data-user-id]');
            for (const row of agenteRows) {
                const userId = row.dataset.userId;
                const servicosSpan = document.getElementById(`agente-servicos-${userId}`);

                try {
                    const response = await fetch(`/api/agente/${userId}/servicos`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.tipos_vinculados && data.tipos_vinculados.length > 0) {
                        servicosSpan.textContent = data.tipos_vinculados.join(', ');
                    } else {
                        servicosSpan.textContent = 'Nenhum serviço vinculado.';
                    }
                } catch (error) {
                    console.error(`Erro ao carregar serviços para o agente ${userId}:`, error);
                    servicosSpan.textContent = 'Erro ao carregar.';
                }
            }
        }

        async function loadAgenteTiposServico(agenteId, formElement) {
            const checkboxes = formElement.querySelectorAll('input[type="checkbox"][name="tipos_servico[]"]');
            checkboxes.forEach(cb => cb.checked = false);

            try {
                const response = await fetch(`/api/agente/${agenteId}/servicos_ids`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.vinculados_ids) {
                    checkboxes.forEach(checkbox => {
                        if (data.vinculados_ids.includes(parseInt(checkbox.value))) {
                            checkbox.checked = true;
                        }
                    });
                }
            } catch (error) {
                console.error(`Erro ao carregar tipos de serviço vinculados para o agente ${agenteId}:`, error);
            }
        }

        horarioEmpreendimentoSelect.addEventListener('change', function () {
            const empreendimentoId = this.value;
            if (empreendimentoId) {
                loadHorariosEmpreendimento(empreendimentoId);
            } else {
                horariosTableBody.innerHTML = '<tr><td colspan="5">Selecione um empreendimento para ver seus horários.</td></tr>';
            }
        });

        async function loadHorariosEmpreendimento(empreendimentoId) {
            horariosTableBody.innerHTML = '<tr><td colspan="5">Carregando horários...</td></tr>';
            try {
                const response = await fetch(`/api/empreendimento/${empreendimentoId}/horarios`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: "Erro desconhecido ao buscar horários." }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                const horarios = await response.json();

                horariosTableBody.innerHTML = '';
                if (horarios.length === 0) {
                    horariosTableBody.innerHTML = '<tr><td colspan="5">Nenhum horário cadastrado para este empreendimento.</td></tr>';
                } else {
                    horarios.forEach(horario => {
                        const row = horariosTableBody.insertRow();
                        const removeUrl = `/remover_horario_funcionamento/${horario.id}`;

                        row.innerHTML = `
                            <td>${horario.empreendimento_nome}</td>
                            <td>${diasSemanaMap[horario.dia_semana]}</td>
                            <td>${horario.hora_inicio}</td>
                            <td>${horario.hora_fim}</td>
                            <td>
                                <form method="POST" action="${removeUrl}" style="display:inline;" class="form-remove">
                                    <input type="hidden" name="empreendimento_id" value="${horario.empreendimento_id}">
                                    <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                                </form>
                            </td>
                        `;
                        const removeForm = row.querySelector('.form-remove');
                        if (removeForm) { addConfirmationToForm(removeForm); }
                    });
                }
            } catch (error) {
                console.error(`Erro ao carregar horários para o empreendimento ${empreendimentoId}:`, error);
                horariosTableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Erro ao carregar horários: ${error.message}</td></tr>`;
            }
        }

        // Lógica para ativar a aba correta na carga da página
        const urlParams = new URLSearchParams(window.location.search);
        const activeTabFromUrl = urlParams.get('tab');
        const activeEmpIdFromUrl = urlParams.get('active_emp_id');

        // Função para ativar a aba
        function activateTab(tabId, keepUnits = false) {
            // Remove 'active' de todos os links do menu
            document.querySelectorAll('.config-menu-link').forEach(link => link.classList.remove('active'));
            // Oculta todas as seções de conteúdo
            contentSections.forEach(section => section.style.display = 'none');

            // Encontra e ativa o link do menu e a seção de conteúdo correspondente
            const targetLink = document.querySelector(`.config-menu-link[data-target="${tabId}"]`);
            const targetSection = document.getElementById(`config-${tabId}`);

            if (targetLink && targetSection) {
                targetLink.classList.add('active');
                targetSection.style.display = 'block';

                // Lógica específica para cada aba ao ser ativada
                if (tabId === 'empreendimentos') {
                    // Garante que a seção de unidades esteja visível apenas se houver um empreendimento ativo na URL
                    if (activeEmpIdFromUrl && keepUnits) {
                        const empRow = document.querySelector(`#empreendimentos-table tr[data-empreendimento-id="${activeEmpIdFromUrl}"]`);
                        if (empRow) {
                            const empName = empRow.querySelector('td:first-child').textContent;
                            loadUnidades(activeEmpIdFromUrl, empName);
                        } else {
                            resetUnidadesView();
                            unidadesSection.style.display = 'block';
                        }
                    } else {
                        resetUnidadesView(); // Garante que a seção de unidades esteja resetada
                        unidadesSection.style.display = 'block'; // Mostra a seção de unidades vazia
                    }
                } else if (tabId === 'usuarios') {
                    loadAgenteServicos();
                } else if (tabId === 'horarios') {
                    const selectedEmpId = horarioEmpreendimentoSelect.value;
                    if (selectedEmpId) {
                        loadHorariosEmpreendimento(selectedEmpId);
                    } else {
                        horariosTableBody.innerHTML = '<tr><td colspan="5">Nenhum horário cadastrado. Selecione um empreendimento acima para ver seus horários ou adicione um novo.</td></tr>';
                    }
                }
                // Não há lógica JS complexa para a aba 'regras' ao ser ativada
            } else {
                console.warn(`Aba com ID "${tabId}" não encontrada. Ativando aba padrão "tipos".`);
                activateTab('tipos'); // Fallback para aba padrão
            }
        }

        // Chamada inicial para ativar a aba correta
        activateTab(activeTabFromUrl || 'tipos', activeTabFromUrl === 'empreendimentos' && !!activeEmpIdFromUrl);
    });
</script>
{% endblock %}