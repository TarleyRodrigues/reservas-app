{% extends 'base.html' %}

{% block head %}
{{ super() }}
<style>
    /* Estilos CSS para a página de configurações */
    .config-page-container {
        display: flex;
        min-height: calc(100vh - 100px);
        /* Ajuste conforme a altura do seu header/footer */
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        /* Garante que o box-shadow seja contido */
        margin: 20px auto;
        max-width: 1200px;
        /* Largura máxima do container */
    }

    .config-sidebar {
        width: 250px;
        background-color: #343a40;
        /* Cor escura para a sidebar */
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .config-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .config-menu li {
        margin-bottom: 10px;
    }

    .config-menu-link {
        display: block;
        padding: 10px 15px;
        color: #f8f9fa;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .config-menu-link:hover,
    .config-menu-link.active {
        background-color: #007bff;
        /* Cor primária para hover/ativo */
        color: white;
    }

    .config-main-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #fff;
    }

    .config-main-content h1 {
        color: #343a40;
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }

    .config-content-section {
        margin-bottom: 30px;
    }

    .config-content-section h2,
    .config-content-section h3 {
        color: #007bff;
        margin-bottom: 20px;
    }

    .config-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }

    .config-form label {
        min-width: 120px;
        /* Para alinhar labels em formulários mais complexos */
        font-weight: bold;
        color: #555;
        text-align: right;
        /* Alinha o texto da label à direita */
        padding-right: 10px;
        /* Espaço entre label e input */
        box-sizing: border-box;
        /* Inclui padding na largura */
    }

    /* Ajuste para que labels fiquem em sua própria linha em telas pequenas */
    @media (max-width: 768px) {
        .config-form label {
            width: 100%;
            text-align: left;
            padding-right: 0;
        }
    }


    .config-form input[type="text"],
    .config-form input[type="number"],
    .config-form input[type="email"],
    .config-form input[type="password"],
    /* Adicionado para o novo formulário de agente */
    .config-form input[type="tel"],
    /* Adicionado para o novo formulário de agente */
    .config-form input[type="time"],
    .config-form select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-width: 180px;
        /* Garante que não fiquem muito pequenos */
    }

    .config-form button {
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        white-space: nowrap;
        /* Evita que o texto do botão quebre */
    }

    /* Tabela base */
    .config-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .config-table thead th {
        background-color: #e9ecef;
        color: #495057;
        padding: 12px 15px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
    }

    .config-table tbody td {
        padding: 10px 15px;
        border-bottom: 1px solid #e2e6ea;
        vertical-align: middle;
    }

    .config-table tbody tr:hover {
        background-color: #f1f1f1;
    }

    /* Estilos para botões */
    .btn {
        display: inline-block;
        font-weight: 400;
        color: #212529;
        text-align: center;
        vertical-align: middle;
        user-select: none;
        background-color: transparent;
        border: 1px solid transparent;
        font-size: 0.875rem;
        /* Menor para sm */
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out,
            border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.765rem;
        border-radius: 0.2rem;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .btn-success {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #218838;
    }

    .btn-warning {
        color: #212529;
        background-color: #ffc107;
        border-color: #ffc107;
    }

    .btn-warning:hover {
        background-color: #e0a800;
        border-color: #e0a800;
    }

    .btn-danger {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    .btn-info {
        color: #fff;
        background-color: #17a2b8;
        border-color: #17a2b8;
    }

    .btn-info:hover {
        background-color: #138496;
        border-color: #117a8b;
    }

    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    /* Estilos para status (Ativo/Inativo) */
    .status {
        display: inline-block;
        padding: 0.3em 0.6em;
        font-size: 0.75em;
        font-weight: bold;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        color: white;
        /* Cor do texto padrão para status */
    }

    .status-active {
        background-color: #28a745;
        /* Verde */
    }

    .status-inactive {
        background-color: #6c757d;
        /* Cinza */
    }

    /* Estilos para o container de serviços do agente */
    .servicos-form-container {
        padding: 15px;
        background-color: #f0f8ff;
        border-left: 5px solid #007bff;
        margin-top: 10px;
        border-radius: 4px;
    }

    .servicos-form-container h4 {
        margin-top: 0;
        color: #0056b3;
        margin-bottom: 15px;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
    }

    .checkbox-item input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
        /* Aumenta um pouco o tamanho do checkbox */
    }

    /* Estilos para mensagens flash (alerts) - embora o JS as transforme em toasts */
    .alert {
        padding: 10px 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .alert-error,
    .alert-danger {
        /* Usando alert-error para consistência com o JS */
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }

    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }

    /* Ajustes para formulários inline na tabela */
    .config-table form {
        margin-bottom: 0;
    }

    .config-table input[type="number"] {
        padding: 5px 8px;
        width: 80px;
        /* Ajuste para inputs de número */
    }

    .config-table .btn-sm {
        margin-left: 5px;
    }

    hr {
        margin-top: 30px;
        margin-bottom: 30px;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, .1);
    }

    /* Responsividade básica */
    @media (max-width: 768px) {
        .config-page-container {
            flex-direction: column;
            margin: 10px;
        }

        .config-sidebar {
            width: 100%;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .config-menu {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .config-menu li {
            margin-bottom: 0;
        }

        .config-menu-link {
            padding: 8px 10px;
            font-size: 0.9em;
        }

        .config-main-content {
            padding: 20px;
        }

        .config-form {
            flex-direction: column;
            align-items: stretch;
        }

        .config-form input,
        .config-form select,
        .config-form button {
            width: 100%;
            min-width: unset;
        }

        /* Reset de alinhamento para labels em telas pequenas */
        .config-form label {
            text-align: left;
            padding-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="config-page-container">
    <div class="config-sidebar">
        <ul class="config-menu">
            <li><a href="#" data-target="tipos" class="config-menu-link">Tipos de Agendamento</a></li>
            <li><a href="#" data-target="empreendimentos" class="config-menu-link">Empreendimentos e Unidades</a></li>
            <li><a href="#" data-target="usuarios" class="config-menu-link">Gerenciamento de Usuários</a></li>
            <li><a href="#" data-target="horarios" class="config-menu-link">Horários de Funcionamento</a></li>
            <li><a href="#" data-target="seguranca" class="config-menu-link">Segurança (Administradores)</a></li>
        </ul>
    </div>

    <div class="config-main-content">
        <h1>Configurações do Sistema</h1>

        {# Mensagens Flash (mantido o fallback, o JS já lida com os toasts) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        {% set toast_type = category %}
        {% if category == 'danger' %}{% set toast_type = 'error' %}{% endif %}
        <div class="alert alert-{{ toast_type }}" style="display:none;">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div id="config-tipos" class="config-content-section">
            <h2>Tipos de Agendamento</h2>
            <form method="POST" action="{{ url_for('adicionar_tipo') }}" class="config-form">
                <label for="novo_tipo_nome">Nome do novo tipo:</label>
                <input type="text" id="novo_tipo_nome" name="novo_tipo" placeholder="Ex: Visita ao Imóvel" required>
                <label for="tipo_duracao">Duração padrão (minutos):</label>
                <input type="number" id="tipo_duracao" name="duracao" placeholder="60" value="60" min="1" required>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Tipo</button>
            </form>
            <table class="config-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Duração Padrão (min)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tipo in tipos %}
                    <tr>
                        <td>{{ tipo.nome }}</td>
                        <td>
                            <span class="status {% if tipo.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if tipo.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('editar_duracao_tipo') }}" style="display:inline;"
                                class="form-edit-duracao">
                                <input type="hidden" name="tipo_id" value="{{ tipo.id }}">
                                <input type="number" name="duracao" value="{{ tipo.duracao_minutos }}" min="1" required
                                    style="width: 70px;">
                                <button type="submit" class="btn btn-success btn-sm">Salvar</button>
                            </form>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('remover_tipo', tipo_id=tipo.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Nenhum tipo de agendamento cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="config-empreendimentos" class="config-content-section" style="display: none;">
            <h2>Empreendimentos</h2>
            <form method="POST" action="{{ url_for('adicionar_empreendimento') }}" class="config-form">
                <label for="novo_empreendimento_nome">Nome do empreendimento:</label>
                <input type="text" id="novo_empreendimento_nome" name="nome" placeholder="Ex: Condomínio Alfa" required>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Empreendimento</button>
            </form>
            <table class="config-table" id="empreendimentos-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Ações</th>
                        <th>Unidades</th>
                    </tr>
                </thead>
                <tbody>
                    {% for empreendimento in empreendimentos %}
                    <tr data-empreendimento-id="{{ empreendimento.id }}">
                        <td>{{ empreendimento.nome }}</td>
                        <td>
                            <span
                                class="status {% if empreendimento.ativo %}status-active{% else %}status-inactive{% endif %}">
                                {% if empreendimento.ativo %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('toggle_empreendimento') }}" style="display:inline;">
                                <input type="hidden" name="empreendimento_id" value="{{ empreendimento.id }}">
                                <button type="submit"
                                    class="btn btn-sm {% if empreendimento.ativo %}btn-toggle btn-warning{% else %}btn-toggle btn-success{% endif %}">
                                    {{ 'Desativar' if empreendimento.ativo else 'Ativar' }}
                                </button>
                            </form>
                            <form method="POST"
                                action="{{ url_for('remover_empreendimento', emp_id=empreendimento.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                            </form>
                        </td>
                        <td>
                            <button class="btn-view-units btn btn-info btn-sm" data-id="{{ empreendimento.id }}">Ver
                                Unidades</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Nenhum empreendimento cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr>
            <div id="unidades-section" style="display: none;">
                <h3 id="unidades-title">Unidades do Empreendimento: <span id="selected-empreendimento-nome"></span></h3>
                <form method="POST" action="{{ url_for('adicionar_unidade') }}" class="config-form"
                    id="form-adicionar-unidade">
                    <input type="hidden" name="empreendimento_id" id="form-unidade-empreendimento-id" value="">
                    <label for="unidade_nome">Nome da nova unidade:</label>
                    <input type="text" id="unidade_nome" name="nome" placeholder="Ex: Apartamento 101" required>
                    <button type="submit" class="btn btn-primary btn-sm">Adicionar Unidade</button>
                </form>
                <table class="config-table" id="unidades-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" id="no-units-message">Selecione um empreendimento para ver suas unidades.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# SEÇÃO DE GERENCIAMENTO DE USUÁRIOS #}
        <div id="config-usuarios" class="config-content-section" style="display: none;">
            <h2>Gerenciamento de Usuários</h2>

            {# NOVO FORMULÁRIO: Adicionar novo Agente #}
            <h3>Cadastrar Novo Agente</h3>
            <form method="POST" action="{{ url_for('adicionar_agente') }}" class="config-form">
                <label for="agente_nome">Nome:</label>
                <input type="text" id="agente_nome" name="nome" placeholder="Nome completo do agente" required>

                <label for="agente_email">Email:</label>
                <input type="email" id="agente_email" name="email" placeholder="email@exemplo.com" required>

                <label for="agente_telefone">Telefone (opcional):</label>
                <input type="tel" id="agente_telefone" name="telefone" placeholder="(XX) XXXXX-XXXX">

                <label for="agente_senha">Senha:</label>
                <input type="password" id="agente_senha" name="senha" placeholder="Mínimo 6 caracteres" required>

                <label for="agente_confirmar_senha">Confirmar Senha:</label>
                <input type="password" id="agente_confirmar_senha" name="confirmar_senha" placeholder="Repita a senha"
                    required>

                <button type="submit" class="btn btn-primary btn-sm">Cadastrar Agente</button>
            </form>

            <hr>

            <h3>Agentes Atuais</h3>
            {% if agente_users %}
            <table class="config-table" id="agente-users-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Tipos de Serviço Vinculados</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in agente_users %}
                    <tr data-user-id="{{ user.id }}" data-user-name="{{ user.nome }}">
                        <td>{{ user.nome if user.nome else 'N/A' }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.telefone if user.telefone else 'Não informado' }}</td>
                        <td>
                            <span id="agente-servicos-{{ user.id }}">
                                Carregando...
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('gerenciar_agente') }}" style="display:inline;"
                                class="form-action-user">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <input type="hidden" name="action" value="demover">
                                <button type="submit" class="btn btn-warning btn-sm">Remover Status Agente</button>
                            </form>
                            <button class="btn btn-info btn-sm btn-gerenciar-servicos" data-user-id="{{ user.id }}"
                                data-user-name="{{ user.nome }}">Gerenciar Serviços</button>
                        </td>
                    </tr>
                    <tr class="agente-servicos-details" id="agente-servicos-row-{{ user.id }}" style="display: none;">
                        <td colspan="5">
                            <div class="servicos-form-container">
                                <h4>Vincular Tipos de Serviço para {{ user.nome if user.nome else user.email }}</h4>
                                <form method="POST" action="{{ url_for('vincular_servicos_agente') }}"
                                    class="form-vincular-servicos">
                                    <input type="hidden" name="agente_id" value="{{ user.id }}">
                                    <div class="checkbox-group">
                                        {% for tipo in tipos %}
                                        <div class="checkbox-item">
                                            <label for="tipo_servico_{{ user.id }}_{{ tipo.id }}">
                                                <input type="checkbox" id="tipo_servico_{{ user.id }}_{{ tipo.id }}"
                                                    name="tipos_servico[]" value="{{ tipo.id }}">
                                                {{ tipo.nome }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">Salvar Vinculação</button>
                                    <button type="button"
                                        class="btn btn-secondary btn-sm btn-cancelar-servicos">Cancelar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum Agente cadastrado no momento.</p>
            {% endif %}

            <hr>

            <h3>Promover Usuário a Agente</h3>
            {% if cliente_users %}
            <form method="POST" action="{{ url_for('gerenciar_agente') }}" id="form-promover-agente"
                class="config-form">
                <label for="promover_agente_user_id">Selecione um usuário:</label>
                <input type="hidden" name="action" value="promover">
                <select id="promover_agente_user_id" name="user_id" required>
                    <option value="">Selecione um usuário...</option>
                    {% for user in cliente_users %}
                    <option value="{{ user.id }}">{{ user.nome if user.nome else user.email }} ({{ user.email }})
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success btn-sm">Tornar Agente</button>
            </form>
            {% else %}
            <p>Não há Clientes para promover a Agente no momento.</p>
            {% endif %}
        </div>

        {# SEÇÃO PARA HORÁRIOS DE FUNCIONAMENTO #}
        <div id="config-horarios" class="config-content-section" style="display: none;">
            <h2>Gerenciar Horários de Funcionamento dos Empreendimentos</h2>

            <h3>Adicionar Horário de Funcionamento</h3>
            <form method="POST" action="{{ url_for('adicionar_horario_funcionamento') }}" class="config-form">
                <label for="horario_empreendimento_id_form">Empreendimento:</label> {# ID diferente do select do JS #}
                <select id="horario_empreendimento_id_form" name="empreendimento_id" required>
                    <option value="" disabled selected>Selecione um empreendimento</option>
                    {% for emp in empreendimentos %}
                    <option value="{{ emp.id }}">{{ emp.nome }}</option>
                    {% endfor %}
                </select>

                <label for="dia_semana_form">Dia da Semana:</label>
                <select id="dia_semana_form" name="dia_semana" required>
                    <option value="" disabled selected>Selecione o dia</option>
                    <option value="0">Segunda-feira</option>
                    <option value="1">Terça-feira</option>
                    <option value="2">Quarta-feira</option>
                    <option value="3">Quinta-feira</option>
                    <option value="4">Sexta-feira</option>
                    <option value="5">Sábado</option>
                    <option value="6">Domingo</option>
                </select>

                <label for="hora_inicio_form">Hora Início:</label>
                <input type="time" id="hora_inicio_form" name="hora_inicio" required>

                <label for="hora_fim_form">Hora Fim:</label>
                <input type="time" id="hora_fim_form" name="hora_fim" required>

                <button type="submit" class="btn btn-primary btn-sm">Adicionar Horário</button>
            </form>

            <hr>

            <h3>Horários Cadastrados</h3>
            <table class="config-table" id="horarios-table">
                <thead>
                    <tr>
                        <th>Empreendimento</th>
                        <th>Dia da Semana</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">Nenhum horário cadastrado. Selecione um empreendimento acima para ver seus
                            horários ou adicione um novo.</td>
                    </tr>
                </tbody>
            </table>
        </div>


        <div id="config-seguranca" class="config-content-section" style="display: none;">
            <h2>Gerenciamento de Administradores</h2>
            <h3>Administradores Atuais</h3>
            {% if admin_users %}
            <table class="config-table" id="admin-users-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for admin_user in admin_users %}
                    <tr>
                        <td>{{ admin_user.nome if admin_user.nome else 'N/A' }}</td>
                        <td>{{ admin_user.email }}</td>
                        <td>{{ admin_user.telefone if admin_user.telefone else 'Não informado' }}</td>
                        <td>
                            {# Não permita que um admin remova a si mesmo ou o super admin #}
                            {% if admin_user.id != current_user.id and admin_user.email != super_admin_email %}
                            <form method="POST" action="{{ url_for('remover_admin', user_id=admin_user.id) }}"
                                style="display:inline;" class="form-remove">
                                <button type="submit" class="btn btn-danger btn-sm">Remover Status Admin</button>
                            </form>
                            {% elif admin_user.id == current_user.id %}
                            <span>(Você)</span>
                            {% elif admin_user.email == super_admin_email %}
                            <span>(Admin Principal)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum administrador configurado (além do principal, se houver).</p>
            {% endif %}
            <hr>
            <h3>Promover Usuário a Administrador</h3>
            {# non_admin_users é agora passado diretamente da rota Flask #}
            {% if non_admin_users %}
            <form method="POST" action="{{ url_for('promover_admin') }}" id="form-promover-admin" class="config-form">
                <label for="promover_admin_user_id">Selecione um usuário:</label>
                <select id="promover_admin_user_id" name="user_to_promote_id" required>
                    <option value="">Selecione um usuário...</option>
                    {% for user in non_admin_users %}
                    <option value="{{ user.id }}">{{ user.nome if user.nome else user.email }} ({{ user.email }}) [{{
                        user.tipo_usuario.capitalize() }}]</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success btn-sm">Tornar Admin</button>
            </form>
            {% else %}
            <p>Não há usuários (clientes ou agentes) para promover a administrador no momento.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const menuLinks = document.querySelectorAll('.config-menu-link');
        const contentSections = document.querySelectorAll('.config-content-section');
        const unidadesSection = document.getElementById('unidades-section');
        const unidadesTableBody = document.querySelector('#unidades-table tbody');
        const selectedEmpreendimentoNome = document.getElementById('selected-empreendimento-nome');
        const formUnidadeEmpreendimentoId = document.getElementById('form-unidade-empreendimento-id');
        const noUnitsMessageRowOriginal = document.getElementById('no-units-message').parentNode.cloneNode(true);

        // O select de empreendimentos para carregar horários, mantendo ID original
        // ATENÇÃO: O ID do select no formulário HTML agora é 'horario_empreendimento_id_form'
        // Mas o JavaScript ainda pode usar 'horario_empreendimento_id' se você tiver um select separado para o JS.
        // Se houver apenas um select de empreendimento para HORÁRIOS, o ID deve ser o mesmo em HTML e JS.
        // Vou assumir que o JS deveria referenciar o mesmo select que o formulário.
        const horarioEmpreendimentoSelect = document.getElementById('horario_empreendimento_id_form'); // CORRIGIDO AQUI
        const horariosTableBody = document.querySelector('#horarios-table tbody');


        const diasSemanaMap = {
            '0': 'Segunda-feira',
            '1': 'Terça-feira',
            '2': 'Quarta-feira',
            '3': 'Quinta-feira',
            '4': 'Sexta-feira',
            '5': 'Sábado',
            '6': 'Domingo'
        };

        function showSection(targetId, keepUnitsVisible = false) {
            contentSections.forEach(section => {
                section.style.display = (section.id === 'config-' + targetId) ? 'block' : 'none';
            });
            menuLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.target === targetId);
            });

            if (targetId !== 'empreendimentos' && !keepUnitsVisible) {
                unidadesSection.style.display = 'none';
            } else if (targetId === 'empreendimentos') {
                const urlParams = new URLSearchParams(window.location.search);
                const activeEmpIdFromUrl = urlParams.get('active_emp_id');
                if (activeEmpIdFromUrl) {
                    const empRow = document.querySelector(`#empreendimentos-table tr[data-empreendimento-id="${activeEmpIdFromUrl}"]`);
                    if (empRow) {
                        const empName = empRow.querySelector('td:first-child').textContent;
                        loadUnidades(activeEmpIdFromUrl, empName);
                    } else {
                        resetUnidadesView();
                        unidadesSection.style.display = 'block';
                    }
                } else if (unidadesTableBody.children.length > 0 && unidadesTableBody.firstChild.id !== 'no-units-message') {
                    unidadesSection.style.display = 'block';
                } else {
                    resetUnidadesView();
                    unidadesSection.style.display = 'block';
                }
            }
            if (targetId === 'usuarios') {
                loadAgenteServicos();
            }
            if (targetId === 'horarios') {
                // Apenas carregue se um empreendimento já estiver selecionado no dropdown de horários
                const selectedEmpId = horarioEmpreendimentoSelect.value;
                if (selectedEmpId) {
                    loadHorariosEmpreendimento(selectedEmpId);
                } else {
                    horariosTableBody.innerHTML = '<tr><td colspan="5">Nenhum horário cadastrado. Selecione um empreendimento acima para ver seus horários ou adicione um novo.</td></tr>';
                }
            }
        }

        menuLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const target = this.dataset.target;
                history.pushState(null, '', `{{ url_for('configuracoes') }}?tab=${target}`);
                showSection(target);
            });
        });

        document.querySelectorAll('.btn-view-units').forEach(button => {
            button.addEventListener('click', function () {
                const empreendimentoId = this.dataset.id;
                const empreendimentoNome = this.closest('tr').querySelector('td:first-child').textContent;
                history.pushState(null, '', `{{ url_for('configuracoes') }}?tab=empreendimentos&active_emp_id=${empreendimentoId}`);
                loadUnidades(empreendimentoId, empreendimentoNome);
            });
        });

        function resetUnidadesView() {
            unidadesTableBody.innerHTML = '';
            unidadesTableBody.appendChild(noUnitsMessageRowOriginal.cloneNode(true));
            selectedEmpreendimentoNome.textContent = '';
            formUnidadeEmpreendimentoId.value = '';
        }

        async function loadUnidades(empreendimentoId, empreendimentoNome) {
            selectedEmpreendimentoNome.textContent = empreendimentoNome;
            formUnidadeEmpreendimentoId.value = empreendimentoId;
            unidadesSection.style.display = 'block';
            unidadesTableBody.innerHTML = '<tr><td colspan="3">Carregando unidades...</td></tr>';

            try {
                // CORREÇÃO: Constrói a URL diretamente no JavaScript, pois 'empreendimento_id' é um parâmetro de rota inteiro.
                const response = await fetch(`/api/empreendimento/${empreendimentoId}/unidades`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: "Erro desconhecido ao buscar unidades." }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                const unidades = await response.json();

                unidadesTableBody.innerHTML = '';
                if (unidades.length === 0) {
                    const noUnitsMsg = noUnitsMessageRowOriginal.cloneNode(true);
                    noUnitsMsg.querySelector('td').textContent = 'Nenhuma unidade cadastrada para este empreendimento.';
                    unidadesTableBody.appendChild(noUnitsMsg);
                } else {
                    unidades.forEach(unidade => {
                        const row = unidadesTableBody.insertRow();
                        // CORREÇÃO: Constrói as URLs de ação diretamente no JavaScript.
                        // Flask espera um ID inteiro no PATH para essas rotas.
                        const toggleUrl = `/toggle_unidade/${unidade.id}`;
                        const removeUrl = `/remover_unidade/${unidade.id}`;

                        row.innerHTML = `
                            <td>${unidade.nome}</td>
                            <td>
                                <span class="status ${unidade.ativo ? 'status-active' : 'status-inactive'}">
                                    ${unidade.ativo ? 'Ativa' : 'Inativa'}
                                </span>
                            </td>
                            <td>
                                <form method="POST" action="${toggleUrl}" style="display:inline;">
                                    <input type="hidden" name="unidade_id" value="${unidade.id}">
                                    <input type="hidden" name="source_empreendimento_id" value="${empreendimentoId}">
                                    <button type="submit" class="btn btn-sm ${unidade.ativo ? 'btn-toggle btn-warning' : 'btn-toggle btn-success'}">
                                        ${unidade.ativo ? 'Desativar' : 'Ativar'}
                                    </button>
                                </form>
                                <form method="POST" action="${removeUrl}" style="display:inline;" class="form-remove">
                                    <input type="hidden" name="source_empreendimento_id" value="${empreendimentoId}">
                                    <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                                </form>
                            </td>
                        `;
                        const removeForm = row.querySelector('.form-remove');
                        if (removeForm) { addConfirmationToForm(removeForm); }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar unidades:', error);
                unidadesTableBody.innerHTML = `<tr><td colspan="3" class="text-danger">Erro ao carregar unidades: ${error.message}</td></tr>`;
            }
        }

        function addConfirmationToForm(form) {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este item? Esta ação não pode ser desfeita.')) {
                    e.preventDefault();
                }
            });
        }
        document.querySelectorAll('form.form-remove').forEach(form => {
            addConfirmationToForm(form);
        });

        document.querySelectorAll('form.form-action-user').forEach(form => {
            form.addEventListener('submit', function (e) {
                const actionType = this.querySelector('input[name="action"]').value;
                let message = '';
                if (actionType === 'promover') {
                    message = 'Tem certeza que deseja promover este usuário a Agente?';
                } else if (actionType === 'demover') {
                    message = 'Tem certeza que deseja remover o status de Agente deste usuário? Ele se tornará um Cliente.';
                } else {
                    message = 'Tem certeza que deseja realizar esta ação?';
                }
                if (!confirm(message)) {
                    e.preventDefault();
                }
            });
        });

        const agenteServicosDetails = document.querySelectorAll('.agente-servicos-details');

        document.querySelectorAll('.btn-gerenciar-servicos').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.dataset.userId;
                const userName = this.dataset.userName;
                const detailRow = document.getElementById(`agente-servicos-row-${userId}`);

                agenteServicosDetails.forEach(row => {
                    if (row.id !== `agente-servicos-row-${userId}`) {
                        row.style.display = 'none';
                    }
                });

                if (detailRow.style.display === 'none') {
                    detailRow.style.display = 'table-row';
                    loadAgenteTiposServico(userId, detailRow.querySelector('.form-vincular-servicos'));
                } else {
                    detailRow.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.btn-cancelar-servicos').forEach(button => {
            button.addEventListener('click', function () {
                this.closest('.agente-servicos-details').style.display = 'none';
            });
        });

        async function loadAgenteServicos() {
            const agenteRows = document.querySelectorAll('#agente-users-table tbody tr[data-user-id]');
            for (const row of agenteRows) {
                const userId = row.dataset.userId;
                const servicosSpan = document.getElementById(`agente-servicos-${userId}`);

                try {
                    const response = await fetch(`/api/agente/${userId}/servicos`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.tipos_vinculados && data.tipos_vinculados.length > 0) {
                        servicosSpan.textContent = data.tipos_vinculados.join(', ');
                    } else {
                        servicosSpan.textContent = 'Nenhum serviço vinculado.';
                    }
                } catch (error) {
                    console.error(`Erro ao carregar serviços para o agente ${userId}:`, error);
                    servicosSpan.textContent = 'Erro ao carregar.';
                }
            }
        }

        async function loadAgenteTiposServico(agenteId, formElement) {
            const checkboxes = formElement.querySelectorAll('input[type="checkbox"][name="tipos_servico[]"]');
            checkboxes.forEach(cb => cb.checked = false);

            try {
                const response = await fetch(`/api/agente/${agenteId}/servicos_ids`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.vinculados_ids) {
                    checkboxes.forEach(checkbox => {
                        if (data.vinculados_ids.includes(parseInt(checkbox.value))) {
                            checkbox.checked = true;
                        }
                    });
                }
            } catch (error) {
                console.error(`Erro ao carregar tipos de serviço vinculados para o agente ${agenteId}:`, error);
            }
        }

        horarioEmpreendimentoSelect.addEventListener('change', function () {
            const empreendimentoId = this.value;
            if (empreendimentoId) {
                loadHorariosEmpreendimento(empreendimentoId);
            } else {
                horariosTableBody.innerHTML = '<tr><td colspan="5">Selecione um empreendimento para ver seus horários.</td></tr>';
            }
        });

        async function loadHorariosEmpreendimento(empreendimentoId) {
            horariosTableBody.innerHTML = '<tr><td colspan="5">Carregando horários...</td></tr>';
            try {
                // CORREÇÃO: Constrói a URL diretamente no JavaScript.
                const response = await fetch(`/api/empreendimento/${empreendimentoId}/horarios`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: "Erro desconhecido ao buscar horários." }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                const horarios = await response.json();

                horariosTableBody.innerHTML = '';
                if (horarios.length === 0) {
                    horariosTableBody.innerHTML = '<tr><td colspan="5">Nenhum horário cadastrado para este empreendimento.</td></tr>';
                } else {
                    horarios.forEach(horario => {
                        const row = horariosTableBody.insertRow();
                        // CORREÇÃO: Constrói a URL de remoção diretamente no JavaScript.
                        const removeUrl = `/remover_horario_funcionamento/${horario.id}`;

                        row.innerHTML = `
                            <td>${horario.empreendimento_nome}</td>
                            <td>${diasSemanaMap[horario.dia_semana]}</td>
                            <td>${horario.hora_inicio}</td>
                            <td>${horario.hora_fim}</td>
                            <td>
                                <form method="POST" action="${removeUrl}" style="display:inline;" class="form-remove">
                                    <input type="hidden" name="empreendimento_id" value="${horario.empreendimento_id}">
                                    <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                                </form>
                            </td>
                        `;
                        const removeForm = row.querySelector('.form-remove');
                        if (removeForm) { addConfirmationToForm(removeForm); }
                    });
                }
            } catch (error) {
                console.error(`Erro ao carregar horários para o empreendimento ${empreendimentoId}:`, error);
                horariosTableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Erro ao carregar horários: ${error.message}</td></tr>`;
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const activeTabFromUrl = urlParams.get('tab');
        const activeEmpIdFromUrl = urlParams.get('active_emp_id');

        if (activeTabFromUrl) {
            showSection(activeTabFromUrl, activeTabFromUrl === 'empreendimentos' && activeEmpIdFromUrl);
        } else {
            showSection('tipos'); // Aba padrão
        }
    });
</script>
{% endblock %}