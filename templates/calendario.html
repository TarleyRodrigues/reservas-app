{% extends 'base.html' %}

{% block head %}
{{ super() }}

{# Injetar permissões do usuário para o JS #}
<script>
    const USER_PERMISSIONS = {
        isAdmin: {{ current_user.is_admin_user | tojson }},
    isAgente: { { current_user.is_agente | tojson } }
        };
</script>

<!-- Importações de CSS do FullCalendar (EXATAMENTE como no seu código antigo que funcionava) -->
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.css" rel="stylesheet">
{# Removida importação de timegrid CSS, pois seu código antigo não a usava. #}

{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="calendar-page-wrapper"> {# NOVO: Wrapper para o efeito glassmorphism #}
        <h1>Calendário de Agendamentos</h1>

        <div style="text-align: center; margin-bottom: 20px;">
            <form action="{{ url_for('agendar') }}">
                <button type="submit" class="btn btn-primary">Fazer Agendamento</button>
            </form>
        </div>

        <div id='calendar'></div>
    </div> {# FIM do calendar-page-wrapper #}
</div>

<!-- Custom Event Detail Modal -->
<div id="eventDetailModal" class="modal hidden"> {# Adicionado 'hidden' para garantir que inicia oculto #}
    <div class="modal-content">
        <span class="close-button">×</span>
        <h2>Detalhes do Agendamento</h2>
        <p><strong>Título:</strong> <span id="modalTitle"></span></p>
        <p><strong>Status:</strong> <span id="modalStatus"></span></p>
        <p><strong>Cliente:</strong> <span id="modalClientName"></span></p>
        <p id="clientContactRow"><strong>Contato do cliente:</strong> <span id="modalClientContact"></span></p>
        <p id="clientEmailRow"><strong>E-mail do cliente:</strong> <span id="modalClientEmail"></span></p>
        <p id="agentAssignedRow"><strong>Agente atribuído:</strong> <span id="modalAgentAssigned"></span></p>
        <p><strong>Serviço:</strong> <span id="modalService"></span></p>
        <p><strong>Local:</strong> <span id="modalLocation"></span></p>
        <p><strong>Observações:</strong> <span id="modalObservations"></span></p>
        <p><strong>Data:</strong> <span id="modalDate"></span></p>
        <p><strong>Hora:</strong> <span id="modalTime"></span></p>
    </div>
</div>

{# MOVIDO: TODOS OS SCRIPTS JS DO FULLCALENDAR E SEU CÓDIGO PARA O FINAL DO BODY #}
{# Isso garante que o DOM esteja pronto e que a biblioteca FullCalendar esteja definida #}
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.js"></script>
{# Removida importação de timegrid JS, pois seu código antigo não a usava. #}
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales-all.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const calendarEl = document.getElementById('calendar');
        const eventDetailModal = document.getElementById('eventDetailModal');
        const closeModalButton = document.querySelector('#eventDetailModal .close-button');

        // Modal elements
        const modalTitle = document.getElementById('modalTitle');
        const modalStatus = document.getElementById('modalStatus');
        const modalClientName = document.getElementById('modalClientName');
        const modalClientContact = document.getElementById('modalClientContact');
        const modalClientEmail = document.getElementById('modalClientEmail');
        const modalAgentAssigned = document.getElementById('modalAgentAssigned');
        const modalService = document.getElementById('modalService');
        const modalLocation = document.getElementById('modalLocation');
        const modalObservations = document.getElementById('modalObservations');
        const modalDate = document.getElementById('modalDate');
        const modalTime = document.getElementById('modalTime');

        // Rows that might be hidden based on permissions
        const clientContactRow = document.getElementById('clientContactRow');
        const clientEmailRow = document.getElementById('clientEmailRow');
        const agentAssignedRow = document.getElementById('agentAssignedRow');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br', // Define o idioma para português
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                // Voltando para o que funcionava no seu código antigo (apenas dayGridMonth e listMonth)
                right: 'dayGridMonth,listMonth'
            },
            // CRÍTICO: Removido o array 'plugins: [...]'. Replicando seu código antigo que FUNCIONAVA.
            // A sua versão do FullCalendar com essas imports globais parece se auto-registrar os plugins.

            // Eventos carregados de forma assíncrona com tratamento de erro
            events: async function (fetchInfo, successCallback, failureCallback) {
                try {
                    const response = await fetch('/eventos');

                    if (response.redirected) {
                        console.error('Requisição /eventos foi redirecionada para:', response.url);
                        alert('Sua sessão expirou ou você não tem permissão para ver os eventos. Por favor, faça login novamente.');
                        window.location.href = response.url;
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido ou resposta não-JSON.' }));
                        console.error('Erro ao buscar eventos:', response.status, response.statusText, errorData);
                        failureCallback({ message: errorData.message || `Erro ao carregar eventos: ${response.status} ${response.statusText}` });
                        alert(`Erro ao carregar eventos: ${errorData.message || response.statusText}. Verifique o console para mais detalhes.`);

                        if ((response.status === 401 || response.status === 403) && errorData.redirect_to) {
                            alert(errorData.message || 'Sua sessão expirou ou você não tem permissão. Redirecionando para login.');
                            window.location.href = errorData.redirect_to;
                        }
                        return;
                    }

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const eventsData = await response.json();
                        successCallback(eventsData);
                    } else {
                        const errorText = await response.text();
                        console.error('Resposta de /eventos não é JSON:', errorText);
                        failureCallback({ message: 'Resposta inválida do servidor (não é JSON).' });
                        alert('Erro ao carregar eventos: Resposta inválida do servidor.');
                    }
                } catch (error) {
                    console.error('Erro de rede ou ao processar eventos:', error);
                    failureCallback(error);
                    alert('Erro de rede ou ao processar eventos. Verifique o console.');
                }
            },
            editable: false,
            eventStartEditable: false,
            eventDurationEditable: false,
            selectable: true,
            eventColor: '#3788d8',

            eventDidMount: function (info) {
                const status = info.event.extendedProps.status;
                if (status) {
                    info.el.classList.add(`event-status-${status}`);
                }
            },

            eventContent: function (arg) {
                if (arg.view.type === 'listMonth') {
                    const observacoes = arg.event.extendedProps.observacoes;
                    return {
                        html: `
                            <div class="fc-event-details">
                                <div class="fc-event-title">${arg.event.title}</div>
                                <div class="fc-event-meta">
                                    <span>${arg.event.extendedProps.usuario_nome}</span> |
                                    <span>${arg.event.extendedProps.unidade}</span> |
                                    <span>${arg.event.extendedProps.empreendimento}</span>
                                </div>
                                ${observacoes && observacoes !== 'N/A' ? `<div class="fc-event-notes">Obs: ${observacoes}</div>` : ''}
                            </div>
                        `
                    };
                }
                return { html: arg.event.title };
            },

            eventClick: function (info) {
                const event = info.event;
                const props = event.extendedProps;

                modalTitle.textContent = event.title;
                modalStatus.textContent = props.status || 'N/A';
                modalClientName.textContent = props.usuario_nome || 'N/A';
                modalService.textContent = props.tipo || 'N/A';
                modalLocation.textContent = `${props.unidade} (${props.empreendimento})`;
                modalObservations.textContent = props.observacoes || 'N/A';

                const eventDate = info.event.start;
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                modalDate.textContent = eventDate.toLocaleDateString('pt-BR', options);
                modalTime.textContent = eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                if (USER_PERMISSIONS.isAdmin || USER_PERMISSIONS.isAgente) {
                    clientContactRow.style.display = 'block';
                    modalClientContact.textContent = props.contato || 'Não informado';

                    clientEmailRow.style.display = 'block';
                    modalClientEmail.textContent = props.usuario_email || 'Não informado';

                    agentAssignedRow.style.display = 'block';
                    modalAgentAssigned.textContent = props.agente_atribuido_nome || 'Não atribuído';
                } else {
                    clientContactRow.style.display = 'none';
                    clientEmailRow.style.display = 'none';
                    agentAssignedRow.style.display = 'none';
                }

                eventDetailModal.classList.remove('hidden');
                eventDetailModal.classList.add('visible');
            }
        });

        calendar.render();

        closeModalButton.addEventListener('click', function () {
            eventDetailModal.classList.remove('visible');
            eventDetailModal.classList.add('hidden');
        });

        window.addEventListener('click', function (event) {
            if (event.target == eventDetailModal) {
                eventDetailModal.classList.remove('visible');
                eventDetailModal.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}