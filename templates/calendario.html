{% extends 'base.html' %}

{% block head %}
{{ super() }}
{# Injetar permissões do usuário para o JS #}
<script>
    const USER_PERMISSIONS = {
        isAdmin: {{ current_user.is_admin_user | tojson }},
    isAgente: { { current_user.is_agente | tojson } }
    };
</script>

<!-- Importações de CSS do FullCalendar (permanecem) -->
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.css" rel="stylesheet">

{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="calendar-page-wrapper">
        <h1>Calendário de Agendamentos</h1>

        <div style="text-align: center; margin-bottom: 20px;">
            <form action="{{ url_for('agendar') }}">
                <button type="submit" class="btn btn-primary">Fazer Agendamento</button>
            </form>
        </div>

        <div id='calendar'></div>
    </div>
</div>

<!-- O modal customizado de detalhes (manter aqui por enquanto) -->
<div id="eventDetailModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button">×</span>
        <h2>Detalhes do Agendamento</h2>
        <p><strong>Título:</strong> <span id="modalTitle"></span></p>
        <p><strong>Status:</strong> <span id="modalStatus"></span></p>
        <p><strong>Cliente:</strong> <span id="modalClientName"></span></p>
        <p id="clientContactRow"><strong>Contato do cliente:</strong> <span id="modalClientContact"></span></p>
        <p id="clientEmailRow"><strong>E-mail do cliente:</strong> <span id="modalClientEmail"></span></p>
        <p id="agentAssignedRow"><strong>Agente atribuído:</strong> <span id="modalAgentAssigned"></span></p>
        <p><strong>Serviço:</strong> <span id="modalService"></span></p>
        <p><strong>Local:</strong> <span id="modalLocation"></span></p>
        <p><strong>Observações:</strong> <span id="modalObservations"></span></p>
        <p><strong>Data:</strong> <span id="modalDate"></span></p>
        <p><strong>Hora:</strong> <span id="modalTime"></span></p>
    </div>
</div>

<!-- Scripts JavaScript - Todos com 'defer' -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales-all.global.min.js" defer></script>

<script defer>
    document.addEventListener('DOMContentLoaded', async function () {
        const calendarEl = document.getElementById('calendar');

        // --- NOVO: Criar o elemento do tooltip personalizado UMA VEZ ---
        let customTooltip = document.createElement('div');
        customTooltip.classList.add('custom-calendar-tooltip');
        document.body.appendChild(customTooltip); // Adiciona ao body para garantir que não será cortado

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },

            events: async function (fetchInfo, successCallback, failureCallback) {
                // ... (seu código events: async function - permanece o mesmo) ...
                try {
                    const response = await fetch('/eventos');

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido ou resposta não-JSON.' }));
                        console.error('Erro ao buscar eventos:', response.status, response.statusText, errorData);
                        failureCallback({ message: errorData.message || `Erro ao carregar eventos: ${response.status} ${response.statusText}` });
                        alert(`Erro ao carregar eventos: ${errorData.message || response.statusText}. Verifique o console para mais detalhes.`);

                        if ((response.status === 401 || response.status === 403) && errorData.redirect_to) {
                            alert(errorData.message || 'Sua sessão expirou ou você não tem permissão. Redirecionando para login.');
                            window.location.href = errorData.redirect_to;
                        }
                        return;
                    }

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const eventsData = await response.json();
                        successCallback(eventsData);
                    } else {
                        const errorText = await response.text();
                        console.error('Resposta de /eventos não é JSON:', errorText);
                        failureCallback({ message: 'Resposta inválida do servidor (não é JSON).' });
                        alert('Erro ao carregar eventos: Resposta inválida do servidor.');
                    }
                } catch (error) {
                    console.error('Erro de rede ou ao processar eventos:', error);
                    failureCallback(error);
                    alert('Erro de rede ou ao processar eventos. Verifique o console.');
                }
            },
            editable: false,
            eventStartEditable: false,
            eventDurationEditable: false,
            selectable: true,
            eventColor: '#3788d8',

            eventDidMount: function (info) {
                const status = info.event.extendedProps.status;
                if (status) {
                    info.el.classList.add(`event-status-${status}`);
                }
            },

            eventContent: function (arg) {
                if (arg.view.type === 'listMonth') {
                    const observacoes = arg.event.extendedProps.observacoes;
                    return {
                        html: `
                            <div class="fc-event-details">
                                <div class="fc-event-title">${arg.event.title}</div>
                                <div class="fc-event-meta">
                                    <span>${arg.event.extendedProps.usuario_nome}</span> |
                                    <span>${arg.event.extendedProps.unidade}</span> |
                                    <span>${arg.event.extendedProps.empreendimento}</span>
                                </div>
                                ${observacoes && observacoes !== 'N/A' ? `<div class="fc-event-notes">Obs: ${observacoes}</div>` : ''}
                            </div>
                        `
                    };
                }
                return { html: arg.event.title };
            },

            // --- NOVO: Lógica para exibir o tooltip personalizado ao passar o mouse ---
            eventMouseEnter: function (info) {
                const props = info.event.extendedProps;

                // Validação defensiva dos dados (importante manter!)
                if (!props || !props.cliente || !props.empreendimento || !props.unidade || !props.contato || !props.hora_agendamento) {
                    console.warn('Dados extendedProps incompletos para o tooltip. Verifique a rota /eventos no app.py.', props);
                    return;
                }

                // Conteúdo do tooltip
                customTooltip.innerHTML = `
                    <strong>Cliente:</strong> ${props.cliente}<br/>
                    <strong>Empreendimento:</strong> ${props.empreendimento}<br/>
                    <strong>Unidade:</strong> ${props.unidade}<br/>
                    <strong>Contato:</strong> ${props.contato}<br/>
                    <strong>Hora do agendamento:</strong> ${props.hora_agendamento}
                `;

                // Posição do tooltip (acima e centralizado no evento)
                const eventRect = info.el.getBoundingClientRect(); // Posição do evento na tela
                const scrollX = window.scrollX || window.pageXOffset;
                const scrollY = window.scrollY || window.pageYOffset;

                // Para calcular a largura/altura do tooltip, ele precisa estar visível (temporariamente)
                customTooltip.style.visibility = 'hidden'; // Esconde primeiro para não "piscar"
                customTooltip.style.display = 'block'; // Garante que ele tenha dimensões

                const tooltipWidth = customTooltip.offsetWidth;
                const tooltipHeight = customTooltip.offsetHeight;

                // Calcula a posição para centralizar acima do evento
                const leftPos = eventRect.left + (eventRect.width / 2) - (tooltipWidth / 2) + scrollX;
                const topPos = eventRect.top - tooltipHeight - 5 + scrollY; // 5px de espaçamento

                customTooltip.style.left = `${leftPos}px`;
                customTooltip.style.top = `${topPos}px`;

                // Exibir o tooltip com um pequeno delay e fade-in
                setTimeout(() => {
                    customTooltip.style.opacity = '1';
                    customTooltip.style.visibility = 'visible';
                }, 100); // Pequeno delay antes de mostrar

            },

            // --- NOVO: Esconder o tooltip personalizado ao sair com o mouse ---
            eventMouseLeave: function (info) {
                // Esconder o tooltip com fade-out
                customTooltip.style.opacity = '0';
                // Atraso antes de realmente esconder (display: none) para permitir a transição
                setTimeout(() => {
                    customTooltip.style.visibility = 'hidden';
                    customTooltip.style.display = 'none';
                }, 300); // Duração da transição CSS
            },

            // Redireciona para a página de detalhes do agendamento
            eventClick: function (info) {
                const eventId = info.event.id;
                window.location.href = `/agendamento/${eventId}`; // Redireciona para a nova rota
            }
        });

        calendar.render();
    });
</script>
{% endblock %}