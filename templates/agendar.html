{% extends 'base.html' %}

{% block title %}Fazer Agendamento{% endblock %}

{% block content %}
<div class="form-wrapper">
    <button class="theme-toggle" aria-label="Alternar modo claro e escuro" id="toggleTheme">ðŸŒ™</button>

    <h2>Fazer Agendamento</h2>

    <a href="{{ url_for('calendario') }}" class="header-btn" style="display: inline-block; margin-bottom: 20px;">
        ðŸ“… Ver CalendÃ¡rio
    </a>

    <form method="POST" action="{{ url_for('agendar') }}">
        {# NOVA ORDEM: Tipo de Agendamento primeiro #}
        <label for="tipo">Tipo de agendamento</label>
        <select id="tipo" name="tipo_id" required>
            <option value="" disabled selected>Selecione o tipo</option>
            {% for tipo in tipos %}
            <option value="{{ tipo.id }}" {% if form_data.tipo_id==tipo.id|string %}selected{% endif %}>{{ tipo.nome }}
            </option>
            {% endfor %}
        </select>

        {# Empreendimento antes de Data/Hora #}
        <label for="empreendimento">Empreendimento</label>
        <select id="empreendimento" name="empreendimento_id" required>
            <option value="" disabled selected>Selecione o empreendimento</option>
            {% for emp in empreendimentos %}
            <option value="{{ emp.id }}" {% if form_data.empreendimento_id==emp.id|string %}selected{% endif %}>{{
                emp.nome }}</option>
            {% endfor %}
        </select>

        {# Unidade, que jÃ¡ Ã© dinÃ¢mica #}
        <label for="unidade">Unidade</label>
        <select id="unidade" name="unidade_id" required>
            <option value="" disabled selected>Selecione a unidade</option>
            {% for unidade in unidades %}
            <option value="{{ unidade.id }}" data-emp="{{ unidade.empreendimento_id }}" {% if
                form_data.unidade_id==unidade.id|string %}selected{% endif %}>
                {{ unidade.nome }} ({{ unidade.nome_empreendimento }})
            </option>
            {% endfor %}
        </select>

        {# ALTERADO AQUI: Nome do Agendamento para Contato #}
        <label for="contato">Contato (telefone, opcional)</label>
        <input id="contato" type="text" name="contato" placeholder="Ex: (XX) XXXX-XXXX ou (XX) 9XXXX-XXXX"
            value="{{ form_data.contato if form_data.contato else '' }}">
        {# Removido 'required' para tornar o campo opcional. Se quiser obrigatÃ³rio, adicione required aqui. #}

        {# Data e Hora agora depois do Empreendimento/Unidade #}
        <label for="data">Data</label>
        <input id="data" type="date" name="data" required value="{{ form_data.data if form_data.data else '' }}">

        <label for="hora">Hora</label>
        <input id="hora" type="time" name="hora" required value="{{ form_data.hora if form_data.hora else '' }}">

        <label for="observacoes">ObservaÃ§Ãµes (opcional)</label>
        <textarea id="observacoes" name="observacoes"
            placeholder="Adicione observaÃ§Ãµes sobre o agendamento (ex: informaÃ§Ãµes adicionais sobre a entrega)">{{ form_data.observacoes if form_data.observacoes else '' }}</textarea>

        <button type="submit" class="btn-agendar">Agendar</button>
    </form>
</div>

<script>
    // Toggle de tema
    const toggleBtn = document.getElementById('toggleTheme');
    const body = document.body;

    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark');
        toggleBtn.textContent = body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
    });

    // Filtro de unidades por empreendimento (manter e adaptar)
    const empreendimentoSelect = document.getElementById('empreendimento');
    const unidadeSelect = document.getElementById('unidade');
    const allUnidadeOptions = Array.from(unidadeSelect.querySelectorAll('option:not([value=""])'));

    function filterUnidades() {
        const empId = empreendimentoSelect.value;

        allUnidadeOptions.forEach(opt => {
            opt.style.display = 'none';
        });

        if (empId) {
            const relevantUnidades = allUnidadeOptions.filter(opt => opt.dataset.emp === empId);
            relevantUnidades.forEach(opt => {
                opt.style.display = 'block';
            });
        }

        const currentSelectedUnidade = unidadeSelect.value;
        const selectedOption = unidadeSelect.querySelector(`option[value="${currentSelectedUnidade}"]`);

        if (selectedOption && selectedOption.dataset.emp !== empId) {
            unidadeSelect.value = '';
        } else if (!selectedOption && currentSelectedUnidade) {
            unidadeSelect.value = '';
        }
    }

    empreendimentoSelect.addEventListener('change', filterUnidades);
    filterUnidades(); // Chamar na carga inicial

</script>
{% endblock %}