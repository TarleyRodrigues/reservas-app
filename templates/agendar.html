{% extends 'base.html' %}

{% block title %}Fazer Agendamento{% endblock %}

{% block content %}
<div class="form-wrapper">
    <button class="theme-toggle" aria-label="Alternar modo claro e escuro" id="toggleTheme">üåô</button>

    <h2>Fazer Agendamento</h2>

    <a href="{{ url_for('calendario') }}" class="header-btn" style="display: inline-block; margin-bottom: 20px;">
        üìÖ Ver Calend√°rio
    </a>

    <form method="POST" action="{{ url_for('agendar') }}">
        <label for="tipo">Tipo de agendamento</label>
        <select id="tipo" name="tipo_id" required>
            <option value="" disabled selected>Selecione o tipo</option>
            {% for tipo in tipos %}
            <option value="{{ tipo.id }}" {% if form_data.tipo_id==tipo.id|string %}selected{% endif %}>{{ tipo.nome }}
            </option>
            {% endfor %}
        </select>

        <label for="empreendimento">Empreendimento</label>
        <select id="empreendimento" name="empreendimento_id" required>
            <option value="" disabled selected>Selecione o empreendimento</option>
            {% for emp in empreendimentos %}
            <option value="{{ emp.id }}" {% if form_data.empreendimento_id==emp.id|string %}selected{% endif %}>{{
                emp.nome }}</option>
            {% endfor %}
        </select>

        <label for="unidade">Unidade</label>
        <select id="unidade" name="unidade_id" required>
            <option value="" disabled selected>Selecione a unidade</option>
            {% for unidade in unidades %}
            <option value="{{ unidade.id }}" data-emp="{{ unidade.empreendimento_id }}" {% if
                form_data.unidade_id==unidade.id|string %}selected{% endif %}>
                {{ unidade.nome }} ({{ unidade.nome_empreendimento }})
            </option>
            {% endfor %}
        </select>

        <label for="contato">Contato (telefone)</label>
        <input id="contato" type="text" name="contato" placeholder="Ex: (XX) XXXX-XXXX ou (XX) 9XXXX-XXXX"
            value="{{ form_data.contato if form_data.contato else '' }}" required>

        <label for="data">Data</label>
        <input id="data" type="date" name="data" required value="{{ form_data.data if form_data.data else '' }}">

        {# ALTERADO AQUI: input type="time" para select #}
        <label for="hora">Hora</label>
        <select id="hora" name="hora" required>
            <option value="" disabled selected>Selecione a hora</option>
            {# Op√ß√µes ser√£o populadas dinamicamente pelo JavaScript #}
        </select>
        {# FIM DA ALTERA√á√ÉO #}

        <label for="observacoes">Observa√ß√µes (opcional)</label>
        <textarea id="observacoes" name="observacoes"
            placeholder="Adicione observa√ß√µes sobre o agendamento (ex: informa√ß√µes adicionais sobre a entrega)">{{ form_data.observacoes if form_data.observacoes else '' }}</textarea>

        <button type="submit" class="btn-agendar">Agendar</button>
    </form>
</div>

<script>
    // Toggle de tema
    const toggleBtn = document.getElementById('toggleTheme');
    const body = document.body;

    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark');
        toggleBtn.textContent = body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    });

    // Elementos do formul√°rio
    const tipoSelect = document.getElementById('tipo');
    const empreendimentoSelect = document.getElementById('empreendimento');
    const unidadeSelect = document.getElementById('unidade');
    const dataInput = document.getElementById('data');
    const horaSelect = document.getElementById('hora'); // Novo: para o select da hora

    // Op√ß√µes de unidade para filtragem
    const allUnidadeOptions = Array.from(unidadeSelect.querySelectorAll('option:not([value=""])'));

    function filterUnidades() {
        const empId = empreendimentoSelect.value;

        allUnidadeOptions.forEach(opt => {
            opt.style.display = 'none';
        });

        if (empId) {
            const relevantUnidades = allUnidadeOptions.filter(opt => opt.dataset.emp === empId);
            relevantUnidades.forEach(opt => {
                opt.style.display = 'block';
            });
        }

        const currentSelectedUnidade = unidadeSelect.value;
        const selectedOption = unidadeSelect.querySelector(`option[value="${currentSelectedUnidade}"]`);

        if (selectedOption && selectedOption.dataset.emp !== empId) {
            unidadeSelect.value = '';
        } else if (!selectedOption && currentSelectedUnidade) {
            unidadeSelect.value = '';
        }
        // Sempre que empreendimento ou unidade muda, os slots de hora podem mudar
        loadAvailableTimeSlots();
    }

    // Fun√ß√£o para carregar e popular os slots de hora
    async function loadAvailableTimeSlots() {
        const selectedTipoId = tipoSelect.value;
        const selectedEmpreendimentoId = empreendimentoSelect.value;
        const selectedUnidadeId = unidadeSelect.value;
        const selectedDate = dataInput.value;

        // Limpar slots existentes e adicionar mensagem de carregamento
        horaSelect.innerHTML = '<option value="" disabled selected>Carregando hor√°rios...</option>';
        horaSelect.disabled = true; // Desabilitar enquanto carrega

        // S√≥ faz a requisi√ß√£o se todos os campos necess√°rios estiverem preenchidos
        if (selectedTipoId && selectedEmpreendimentoId && selectedUnidadeId && selectedDate) {
            try {
                const response = await fetch(`/api/slots_disponiveis?tipo_id=${selectedTipoId}&empreendimento_id=${selectedEmpreendimentoId}&unidade_id=${selectedUnidadeId}&data=${selectedDate}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro ao carregar slots:', errorData.error);
                    horaSelect.innerHTML = '<option value="" disabled selected>Erro ao carregar hor√°rios</option>';
                    alert(`N√£o foi poss√≠vel carregar os hor√°rios dispon√≠veis: ${errorData.error || response.statusText}`);
                } else {
                    const data = await response.json();
                    const slots = data.slots_disponiveis;

                    horaSelect.innerHTML = '<option value="" disabled selected>Selecione a hora</option>';
                    if (slots.length > 0) {
                        slots.forEach(slot => {
                            const option = document.createElement('option');
                            option.value = slot;
                            option.textContent = slot;
                            // Se o form_data tem uma hora pr√©-selecionada (ap√≥s um erro de valida√ß√£o)
                            if ('{{ form_data.hora|e }}' === slot) { // Usar Jinja para pr√©-selecionar
                                option.selected = true;
                            }
                            horaSelect.appendChild(option);
                        });
                        horaSelect.disabled = false; // Habilitar o select
                    } else {
                        horaSelect.innerHTML = '<option value="" disabled selected>Nenhum hor√°rio dispon√≠vel</option>';
                    }
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o da API de slots:', error);
                horaSelect.innerHTML = '<option value="" disabled selected>Erro de conex√£o</option>';
                alert('Erro de conex√£o ao buscar hor√°rios dispon√≠veis.');
            }
        } else {
            horaSelect.innerHTML = '<option value="" disabled selected>Preencha Tipo, Empreendimento, Unidade e Data</option>';
        }
    }

    // Adicionar listeners para quando os campos relevantes mudarem
    tipoSelect.addEventListener('change', loadAvailableTimeSlots);
    empreendimentoSelect.addEventListener('change', filterUnidades); // filterUnidades j√° chama loadAvailableTimeSlots
    unidadeSelect.addEventListener('change', loadAvailableTimeSlots);
    dataInput.addEventListener('change', loadAvailableTimeSlots);

    // Chamar as fun√ß√µes na carga inicial da p√°gina
    filterUnidades(); // Garante que as unidades corretas estejam vis√≠veis
    loadAvailableTimeSlots(); // Carrega os slots iniciais se os campos estiverem preenchidos (repopula√ß√£o)

    // Ajuste para pr√©-sele√ß√£o inicial de empreendimento e unidade se houver form_data
    // Isso √© importante se a p√°gina for repopulada ap√≥s um erro e o empreendimento j√° estava selecionado
    const initialEmpId = '{{ form_data.empreendimento_id | e }}';
    const initialUnidadeId = '{{ form_data.unidade_id | e }}';
    if (initialEmpId) {
        empreendimentoSelect.value = initialEmpId;
        // Chamar filterUnidades novamente para garantir que as op√ß√µes da unidade estejam vis√≠veis
        filterUnidades();
    }
    if (initialUnidadeId) {
        unidadeSelect.value = initialUnidadeId;
    }
</script>
{% endblock %}