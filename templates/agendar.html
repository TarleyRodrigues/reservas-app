{% extends 'base.html' %}

{% block title %}Fazer Agendamento{% endblock %}

{% block content %}
<div class="form-wrapper">
    <button class="theme-toggle" aria-label="Alternar modo claro e escuro" id="toggleTheme">üåô</button>

    <h2>Fazer Agendamento</h2>

    <a href="{{ url_for('calendario') }}" class="header-btn" style="display: inline-block; margin-bottom: 20px;">
        üìÖ Ver Calend√°rio
    </a>

    <form method="POST" action="{{ url_for('agendar') }}">
        {# NOVA ORDEM: Tipo de Agendamento primeiro #}
        <label for="tipo">Tipo de agendamento</label>
        <select id="tipo" name="tipo_id" required>
            <option value="" disabled selected>Selecione o tipo</option>
            {% for tipo in tipos %}
            <option value="{{ tipo.id }}" {% if form_data.tipo_id==tipo.id|string %}selected{% endif %}>{{ tipo.nome }}
            </option>
            {% endfor %}
        </select>

        {# Empreendimento antes de Data/Hora #}
        <label for="empreendimento">Empreendimento</label>
        <select id="empreendimento" name="empreendimento_id" required>
            <option value="" disabled selected>Selecione o empreendimento</option>
            {% for emp in empreendimentos %}
            <option value="{{ emp.id }}" {% if form_data.empreendimento_id==emp.id|string %}selected{% endif %}>{{
                emp.nome }}</option>
            {% endfor %}
        </select>

        {# Unidade, que j√° √© din√¢mica #}
        <label for="unidade">Unidade</label>
        <select id="unidade" name="unidade_id" required>
            <option value="" disabled selected>Selecione a unidade</option>
            {% for unidade in unidades %}
            <option value="{{ unidade.id }}" data-emp="{{ unidade.empreendimento_id }}" {% if
                form_data.unidade_id==unidade.id|string %}selected{% endif %}>
                {{ unidade.nome }} ({{ unidade.nome_empreendimento }})
            </option>
            {% endfor %}
        </select>

        {# Nome do Cliente (se o agendamento for para outro) #}
        <label for="nome">Nome do Agendamento</label>
        <input id="nome" type="text" name="nome" placeholder="Digite o nome para o agendamento (Ex: Nome do Cliente)"
            required value="{{ form_data.nome if form_data.nome else '' }}">

        {# Data e Hora agora depois do Empreendimento/Unidade #}
        <label for="data">Data</label>
        <input id="data" type="date" name="data" required value="{{ form_data.data if form_data.data else '' }}">

        <label for="hora">Hora</label>
        <input id="hora" type="time" name="hora" required value="{{ form_data.hora if form_data.hora else '' }}">

        <label for="observacoes">Observa√ß√µes (opcional)</label>
        <textarea id="observacoes" name="observacoes"
            placeholder="Adicione observa√ß√µes sobre o agendamento (ex: informa√ß√µes adicionais sobre a entrega)">{{ form_data.observacoes if form_data.observacoes else '' }}</textarea>

        <button type="submit" class="btn-agendar">Agendar</button>
    </form>
</div>

<script>
    // Toggle de tema
    const toggleBtn = document.getElementById('toggleTheme');
    const body = document.body;

    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark');
        toggleBtn.textContent = body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    });

    // Filtro de unidades por empreendimento (manter e adaptar)
    const empreendimentoSelect = document.getElementById('empreendimento');
    const unidadeSelect = document.getElementById('unidade');
    const allUnidadeOptions = Array.from(unidadeSelect.querySelectorAll('option:not([value=""])')); // Todas as op√ß√µes, exceto a primeira "Selecione a unidade"

    function filterUnidades() {
        const empId = empreendimentoSelect.value;

        // Esconder todas as unidades primeiro
        allUnidadeOptions.forEach(opt => {
            opt.style.display = 'none';
        });

        // Mostrar apenas as unidades do empreendimento selecionado
        if (empId) {
            const relevantUnidades = allUnidadeOptions.filter(opt => opt.dataset.emp === empId);
            relevantUnidades.forEach(opt => {
                opt.style.display = 'block';
            });
        }

        // Se a unidade selecionada n√£o pertence mais ao empreendimento atual, resetar
        const currentSelectedUnidade = unidadeSelect.value;
        const selectedOption = unidadeSelect.querySelector(`option[value="${currentSelectedUnidade}"]`);

        if (selectedOption && selectedOption.dataset.emp !== empId) {
            unidadeSelect.value = ''; // Resetar se a unidade selecionada n√£o for do novo empreendimento
        } else if (!selectedOption && currentSelectedUnidade) {
            // Se a unidade selecionada n√£o existe mais (ex: ap√≥s um erro de valida√ß√£o que removeu uma op√ß√£o inv√°lida)
            unidadeSelect.value = '';
        }
    }

    // Chamar a fun√ß√£o de filtro ao carregar a p√°gina e quando o empreendimento muda
    empreendimentoSelect.addEventListener('change', filterUnidades);

    // Chamar filterUnidades uma vez na carga inicial para garantir que as unidades corretas j√° estejam vis√≠veis
    // (especialmente se o formul√°rio for repopulado ap√≥s um erro)
    filterUnidades();

</script>
{% endblock %}